@page
@model ProyectoSaunaKalixto.Web.Pages.Inventario.IndexModel
@{
    ViewData["Title"] = "Sistema de Inventario";
    Layout = "_LayoutSidebar";
}

<style>
:root {
        /* PALETA PRINCIPAL */
        --primary: #4f46e5;
        --primary-soft: #818cf8;
        --primary-dark: #3730a3;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --info: #06b6d4;

        /* SUPERFICIES */
        --surface: #ffffff;
        --surface-dark: #f3f4f6;
        --surface-soft: #f9fafb;
        --border: #e5e7eb;

        /* TEXTO */
        --text: #0f172a;
        --text-muted: #6b7280;

        /* SOMBRAS */
        --shadow-xs: 0 1px 2px 0 rgb(15 23 42 / 0.05);
        --shadow: 0 4px 10px rgb(15 23 42 / 0.08);
        --shadow-lg: 0 20px 35px rgb(15 23 42 / 0.12);
        --glass-blur: 12px;
        --radius: 0.9rem;
        --grad-start: #4f46e5;
        --grad-end: #06b6d4;
        --grad-angle: 135deg;
    }

    body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        overflow-x: hidden; /* AGREGAR */
        overflow-y: auto;   /* AGREGAR */
    }

    body.modal-open { 
        overflow: hidden; 
    }

    /* AGREGAR: Prevenir conflictos de scroll */
    html {
        overflow-y: scroll;
        scroll-behavior: smooth;
    }
    * {
        box-sizing: border-box;
    }

    body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body.modal-open { overflow: hidden; }

    /* =========================
       LAYOUT GENERAL
    ==========================*/
        .container-inventory {
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden; 
        background: radial-gradient(circle at top left, #eef2ff 0, #f9fafb 40%, #f3f4f6 100%);
        animation: bgShift 14s ease-in-out infinite alternate;
    }

    /* =========================
   AUTOCOMPLETE SUGERENCIAS
==========================*/
.suggest-box {
    position: relative;
}

.suggest-list {
    position: absolute;
    left: 0;
    right: 0;
    z-index: 100000 !important; /* Mayor que el modal */
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 0.5rem;
    max-height: 240px;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
    margin-top: 0.25rem;
}

.suggest-item {
    padding: 0.65rem 0.75rem;
    cursor: pointer;
    font-size: 0.82rem;
    color: var(--text);
    border-bottom: 1px solid var(--surface-dark);
    transition: all 0.15s ease;
}

.suggest-item:last-child {
    border-bottom: none;
}

.suggest-item:hover,
.suggest-item.active {
    background: var(--primary-soft);
    color: white;
}

.suggest-item strong {
    color: var(--primary);
}

.suggest-item:hover strong {
    color: white;
}

    /* =========================
       HEADER COMPACTO PREMIUM
    ==========================*/
    .header-compact {
        background: linear-gradient(135deg, rgba(79, 70, 229, 0.08), rgba(6, 182, 212, 0.04));
        border-bottom: 1px solid rgba(148, 163, 184, 0.35);
        padding: 0.9rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
        backdrop-filter: blur(10px);
        position: relative;
        z-index: 5;
    }

    /* Botones de tipo de movimiento */
    .type-selector { display:flex; gap:.5rem; align-items:center; }
    .type-selector input[type="radio"] { position:absolute; opacity:0; width:1px; height:1px; }
    .type-btn { display:inline-flex; align-items:center; gap:.35rem; padding:.5rem .9rem; border-radius:.6rem; border:1px solid var(--border); background: var(--surface-dark); color: var(--text); font-weight:600; cursor:pointer; user-select:none; transition: all .15s ease; }
    .type-selector input[type="radio"]:checked + label.entrada { background: var(--success) !important; color:#fff !important; border-color: var(--success) !important; }
    .type-selector input[type="radio"]:checked + label.salida { background: var(--danger) !important; color:#fff !important; border-color: var(--danger) !important; }
    .type-btn.entrada.active { background: var(--success) !important; color:#fff !important; border-color: var(--success) !important; }
    .type-btn.salida.active { background: var(--danger) !important; color:#fff !important; border-color: var(--danger) !important; }
    .type-btn:not(.active) { box-shadow:none; }

    .header-compact::after {
        content: '';
        position: absolute;
        inset: 0;
        pointer-events: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.5);
        opacity: 0.4;
    }

    .header-title {
        font-size: 1.15rem;
        font-weight: 800;
        color: var(--text);
        margin: 0;
        letter-spacing: 0.02em;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .header-title::before {
        content: '';
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 30%, #a5b4fc, #4f46e5);
        box-shadow: 0 0 0 6px rgba(129, 140, 248, 0.2);
        animation: orbit 3s ease-in-out infinite;
    }

    .header-actions {
        display: flex;
        gap: 0.5rem;
    }

    /* =========================
       BOTONES PREMIUM
    ==========================*/
    .btn-premium {
        padding: 0.5rem 1rem;
        border-radius: 0.6rem;
        font-size: 0.8125rem;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.18s ease-out;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        white-space: nowrap;
        box-shadow: var(--shadow-xs);
        transform: translateY(0);
    }

    .btn-premium svg {
        width: 1rem;
        height: 1rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary), var(--primary-soft));
        color: white;
        box-shadow: 0 6px 18px rgba(79, 70, 229, 0.35);
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, var(--primary-dark), var(--primary));
        transform: translateY(-1px) scale(1.01);
        box-shadow: var(--shadow-lg);
    }

    .btn-success {
        background: linear-gradient(135deg, var(--success), #34d399);
        color: white;
        box-shadow: 0 6px 18px rgba(16, 185, 129, 0.35);
    }

    .btn-success:hover {
        background: linear-gradient(135deg, #059669, var(--success));
        transform: translateY(-1px) scale(1.01);
        box-shadow: var(--shadow-lg);
    }

    .btn-muted {
        background: rgba(248, 250, 252, 0.95);
        color: var(--text);
        border: 1px solid var(--border);
        box-shadow: none;
    }

    .btn-muted:hover {
        background: #e5e7eb;
    }

    .btn-icon {
        padding: 0.5rem;
        border-radius: 0.45rem;
    }

    /* =========================
       ESTADÍSTICAS COMPACTAS
    ==========================*/
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(5, minmax(0, 1fr));
        gap: 0.8rem;
        padding: 0.85rem 1.5rem;
        background: transparent;
        flex-shrink: 0;
    }

    .stat-card-mini {
        background: rgba(255, 255, 255, 0.92);
        border: 1px solid rgba(226, 232, 240, 0.9);
        border-radius: 0.85rem;
        padding: 0.8rem;
        transition: all 0.18s ease-out;
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow-xs);
        backdrop-filter: blur(8px);
    }

    .stat-card-mini::before {
        content: '';
        position: absolute;
        inset: 0;
        opacity: 0;
        transition: opacity 0.25s, transform 0.25s;
        transform: translateY(12px);
    }

    .stat-card-mini.primary::before {
        background: radial-gradient(circle at top left, rgba(79, 70, 229, 0.22), transparent 60%);
    }

    .stat-card-mini.success::before {
        background: radial-gradient(circle at top left, rgba(16, 185, 129, 0.24), transparent 60%);
    }

    .stat-card-mini.info::before {
        background: radial-gradient(circle at top left, rgba(6, 182, 212, 0.24), transparent 60%);
    }

    .stat-card-mini.warning::before {
        background: radial-gradient(circle at top left, rgba(245, 158, 11, 0.28), transparent 60%);
    }

    .stat-card-mini.danger::before {
        background: radial-gradient(circle at top left, rgba(239, 68, 68, 0.28), transparent 60%);
    }

    .stat-card-mini:hover {
        border-color: rgba(129, 140, 248, 0.7);
        box-shadow: var(--shadow);
        transform: translateY(-2px);
    }

    .stat-card-mini:hover::before {
        opacity: 1;
        transform: translateY(0);
    }

    .stat-label {
        font-size: 0.68rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: var(--text-muted);
        margin-bottom: 0.25rem;
    }

    .stat-value {
        font-size: 1.55rem;
        font-weight: 800;
        color: var(--text);
        line-height: 1;
        letter-spacing: 0.01em;
    }

    .stat-meta {
        font-size: 0.7rem;
        color: var(--text-muted);
        margin-top: 0.3rem;
    }

    /* =========================
       BARRA DE FILTROS
    ==========================*/
    .filters-bar {
        background: rgba(255, 255, 255, 0.98);
        padding: 0.8rem 1.5rem;
        border-top: 1px solid rgba(226, 232, 240, 0.9);
        border-bottom: 1px solid rgba(226, 232, 240, 0.9);
        display: flex;
        gap: 0.75rem;
        align-items: flex-end;
        flex-wrap: wrap;
        flex-shrink: 0;
        box-shadow: 0 8px 16px rgba(15, 23, 42, 0.03);
    }

    .filter-group {
        flex: 1;
        min-width: 160px;
    }

    .filter-label {
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        color: var(--text-muted);
        margin-bottom: 0.25rem;
        display: block;
        letter-spacing: 0.06em;
    }

    .filter-input {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        font-size: 0.82rem;
        transition: all 0.16s ease-out;
        background: #f9fafb;
        color: var(--text);
    }

    .filter-input:focus {
        outline: none;
        border-color: rgba(79, 70, 229, 0.7);
        box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.35);
        background: white;
    }

    /* =========================
       TABS SUPERIORES
    ==========================*/
    .tabs-container {
        background: transparent;
        padding: 0.4rem 1.5rem 0.1rem;
        display: flex;
        gap: 0.4rem;
        flex-shrink: 0;
        border-bottom: 1px solid rgba(226, 232, 240, 0.9);
    }

    .tab-btn {
        padding: 0.55rem 0.95rem;
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-muted);
        background: transparent;
        border: none;
        border-radius: 999px;
        cursor: pointer;
        transition: all 0.15s ease-out;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        position: relative;
    }

    .tab-btn svg {
        width: 1rem;
        height: 1rem;
    }

    .tab-btn::after {
        content: '';
        position: absolute;
        left: 50%;
        bottom: -0.4rem;
        width: 0;
        height: 2px;
        border-radius: 999px;
        background: linear-gradient(90deg, var(--primary), var(--info));
        transition: all 0.18s ease-out;
        transform: translateX(-50%);
        opacity: 0;
    }

    .tab-btn:hover {
        color: var(--text);
        background: rgba(226, 232, 240, 0.5);
    }

    .tab-btn.active {
        color: var(--primary);
        background: rgba(224, 231, 255, 0.9);
        box-shadow: 0 8px 18px rgba(129, 140, 248, 0.25);
    }

    .tab-btn.active::after {
        width: 70%;
        opacity: 1;
    }

    .tab-content.hidden {
        display: none;
    }

    /* =========================
       ÁREA DE CONTENIDO
    ==========================*/
    .content-area {
        flex: 1;
        overflow-y: auto; /* Mantener esto */
        overflow-x: hidden; /* Agregar esta línea */
        padding: 1rem 1.5rem 1.25rem;
        background: transparent;
        min-height: 0; /* AGREGAR esta línea - es crítica para el flex scroll */
    }

    .content-area::-webkit-scrollbar {
        width: 8px;
    }

    .content-area::-webkit-scrollbar-track {
        background: rgba(248, 250, 252, 0.9);
    }

    .content-area::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.8);
        border-radius: 999px;
    }

    .content-area::-webkit-scrollbar-thumb:hover {
        background: rgba(107, 114, 128, 0.9);
    }

    /* =========================
       TABLA PREMIUM
    ==========================*/
    .table-container {
        background: rgba(255, 255, 255, 0.98);
        border-radius: 0.85rem;
        border: 1px solid rgba(226, 232, 240, 0.9);
        overflow: hidden;
        box-shadow: var(--shadow);
    }

    .table-premium {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.82rem;
    }

    .table-premium thead {
        background: linear-gradient(to bottom, #f9fafb, #eff3ff);
        border-bottom: 1px solid rgba(226, 232, 240, 0.9);
    }

    .table-premium th {
        padding: 0.65rem 0.75rem;
        text-align: left;
        font-weight: 700;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        white-space: nowrap;
    }

    .table-premium tbody tr {
        border-bottom: 1px solid rgba(243, 244, 246, 0.95);
        transition: background 0.12s ease-out, transform 0.1s ease-out, box-shadow 0.1s ease-out;
    }

    .table-premium tbody tr:nth-child(even) {
        background: rgba(249, 250, 251, 0.6);
    }

    .table-premium tbody tr:hover {
        background: #eef2ff;
        box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.4) inset;
        transform: translateY(-1px);
    }

    .table-premium td {
        padding: 0.65rem 0.75rem;
        color: var(--text);
        vertical-align: middle;
    }

    /* =========================
       BADGES
    ==========================*/
    .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.625rem;
        border-radius: 999px;
        font-size: 0.7rem;
        font-weight: 700;
        line-height: 1;
    }

    .badge-primary {
        background: #e0e7ff;
        color: #3730a3;
    }

    .badge-success {
        background: #d1fae5;
        color: #065f46;
    }

    .badge-warning {
        background: #fef3c7;
        color: #92400e;
    }

    .badge-danger {
        background: #fee2e2;
        color: #991b1b;
    }

    .badge-info {
        background: #e0f2fe;
        color: #075985;
    }

    .badge-dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    @@keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(1.2); }
    }

    .code-badge {
        font-family: 'JetBrains Mono', 'Monaco', 'Courier New', monospace;
        background: #0b1120;
        color: #e5e7eb;
        padding: 0.18rem 0.45rem;
        border-radius: 0.35rem;
        font-size: 0.72rem;
        font-weight: 600;
        border: 1px solid rgba(148, 163, 184, 0.45);
    }

    /* =========================
       NOTIFICACIONES TOAST
    ==========================*/
    .notification {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 2000;
        min-width: 320px;
        max-width: 380px;
        background: rgba(15, 23, 42, 0.96);
        border-radius: 0.9rem;
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.45);
        border: 1px solid rgba(148, 163, 184, 0.5);
        padding: 0.9rem;
        animation: slideIn 0.28s ease-out;
        color: #e5e7eb;
        backdrop-filter: blur(12px);
    }

    @@keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(120%);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .notification.success {
        border-left: 4px solid var(--success);
    }

    .notification.error {
        border-left: 4px solid var(--danger);
    }

    .notification-content {
        display: flex;
        gap: 0.75rem;
    }

    .notification-icon {
        flex-shrink: 0;
        width: 1.25rem;
        height: 1.25rem;
    }

    .notification-body {
        flex: 1;
    }

    .notification-title {
        font-size: 0.82rem;
        font-weight: 700;
        margin-bottom: 0.1rem;
    }

    .notification-message {
        font-size: 0.76rem;
        color: #cbd5f5;
    }

    /* =========================
       EMPTY STATE
    ==========================*/
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
    }

    .empty-icon {
        width: 4rem;
        height: 4rem;
        margin: 0 auto 1rem;
        color: var(--text-muted);
        opacity: 0.55;
    }

    .empty-title {
        font-size: 1rem;
        font-weight: 800;
        color: var(--text);
        margin-bottom: 0.5rem;
    }

    .empty-message {
        font-size: 0.82rem;
        color: var(--text-muted);
        margin-bottom: 1.5rem;
    }

    /* =========================
       ACCIONES POR FILA
    ==========================*/
    .actions-group {
        display: flex;
        gap: 0.25rem;
    }

    .btn-action {
        padding: 0.4rem;
        border-radius: 0.45rem;
        border: none;
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.15s ease-out;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .btn-action svg {
        width: 1rem;
        height: 1rem;
    }

    .btn-action:hover {
        background: #e5e7eb;
        color: var(--text);
        transform: translateY(-1px);
    }

    .btn-action.edit:hover {
        color: var(--primary);
    }

    .btn-action.stock:hover {
        color: var(--info);
    }

    .btn-action.delete:hover {
        color: var(--danger);
    }

    /* =========================
       STOCK DISPLAY
    ==========================*/
    .stock-display {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
    }

    .stock-value {
        font-size: 1.15rem;
        font-weight: 800;
        color: var(--text);
    }

    .stock-action {
        font-size: 0.7rem;
        padding: 0.22rem 0.6rem;
        border-radius: 0.35rem;
        background: linear-gradient(135deg, var(--primary), var(--primary-soft));
        color: white;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.16s;
        box-shadow: 0 6px 15px rgba(79, 70, 229, 0.35);
    }

    .stock-action:hover {
        background: linear-gradient(135deg, var(--primary-dark), var(--primary));
        transform: translateY(-1px);
    }

    .stock-min {
        font-size: 0.7rem;
        color: var(--text-muted);
    }

    /* =========================
       TYPE SELECTOR (ENTRADA / SALIDA)
    ==========================*/
    .type-selector {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.5rem;
    }

    .type-btn {
        padding: 0.7rem;
        border-radius: 0.55rem;
        border: 2px solid var(--border);
        background: var(--surface-soft);
        color: var(--text-muted);
        cursor: pointer;
        font-weight: 700;
        font-size: 0.8rem;
        transition: all 0.16s ease-out;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.375rem;
    }

    .type-btn svg {
        width: 1rem;
        height: 1rem;
    }

    .type-btn:hover {
        border-color: var(--primary-soft);
        background: white;
        color: var(--text);
    }

    .type-btn.active {
        border-color: var(--primary);
        background: var(--primary);
        color: white;
        box-shadow: 0 8px 20px rgba(79, 70, 229, 0.35);
    }

    .type-btn.entrada.active {
        border-color: var(--success);
        background: var(--success);
    }

    .type-btn.salida.active {
        border-color: var(--danger);
        background: var(--danger);
    }

    /* =========================
       CARDS DE MOVIMIENTOS
    ==========================*/
    .movement-card {
        background: rgba(255, 255, 255, 0.96);
        border: 1px solid rgba(226, 232, 240, 0.9);
        border-radius: 0.85rem;
        padding: 0.9rem;
        margin-bottom: 0.65rem;
        transition: all 0.18s ease-out;
        box-shadow: var(--shadow-xs);
    }

    .movement-card:hover {
        box-shadow: var(--shadow);
        border-color: rgba(129, 140, 248, 0.75);
        transform: translateY(-2px);
    }

    .movement-header {
        display: flex;
        align-items: center;
        gap: 0.85rem;
        margin-bottom: 0.25rem;
    }

    .movement-icon {
        width: 2.2rem;
        height: 2.2rem;
        border-radius: 0.6rem;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .movement-icon.entrada {
        background: #d1fae5;
        color: var(--success);
    }

    .movement-icon.salida {
        background: #fee2e2;
        color: var(--danger);
    }

    .movement-details {
        flex: 1;
    }

    .movement-product {
        font-size: 0.83rem;
        font-weight: 700;
        color: var(--text);
    }

    .movement-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        font-size: 0.7rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
    }

    /* =========================
       MODALES PREMIUM - CORREGIDO
    ==========================*/
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        backdrop-filter: blur(12px);
        display: none;
        visibility: hidden;
        opacity: 0;
        align-items: center;
        justify-content: center;
        z-index: 99999;
        padding: 1rem;
        transition: opacity 0.3s ease-out, visibility 0.3s ease-out;
    }

    .modal-overlay.active {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    .modal-overlay.modal-opening {
        pointer-events: none;
    }

    .modal-content {
        background: rgba(255, 255, 255, 0.98);
        border-radius: var(--radius, 0.9rem);
        box-shadow: 0 25px 60px rgba(15, 23, 42, 0.55);
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        border: 1px solid rgba(226, 232, 240, 0.9);
        will-change: transform, opacity;
        animation: springOpen 0.33s cubic-bezier(0.34, 1.56, 0.64, 1);
        pointer-events: auto;
    }

    .modal-content.modal-sm { max-width: 28rem; }
    .modal-content.modal-md { max-width: 36rem; }
    .modal-content.modal-lg { max-width: 48rem; }

    @@keyframes springOpen {
        0% { opacity: 0; transform: translateY(18px) scale(0.96); }
        60% { opacity: 1; transform: translateY(-6px) scale(1.02); }
        100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    .modal-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid rgba(226, 232, 240, 0.9);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: linear-gradient(to right, #f9fafb, #eef2ff);
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .modal-title {
        font-size: 1rem;
        font-weight: 800;
        color: var(--text);
    }

    .modal-body {
        padding: 1.25rem;
        max-height: calc(90vh - 140px);
        overflow-y: auto;
    }

    .modal-body::-webkit-scrollbar {
        width: 6px;
    }

    .modal-body::-webkit-scrollbar-track {
        background: rgba(248, 250, 252, 0.9);
    }

    .modal-body::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.8);
        border-radius: 999px;
    }

    .modal-body::-webkit-scrollbar-thumb:hover {
        background: rgba(107, 114, 128, 0.9);
    }

    .modal-footer {
        padding: 1rem 1.25rem;
        border-top: 1px solid rgba(226, 232, 240, 0.9);
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
        background: #f9fafb;
        position: sticky;
        bottom: 0;
        z-index: 10;
    }

    /* =========================
       FORMULARIOS
    ==========================*/
    .form-grid {
        display: grid;
        gap: 0.9rem;
    }

    .form-grid.cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-label {
        font-size: 0.78rem;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 0.35rem;
    }

    .form-label .required {
        color: var(--danger);
    }

    .form-input,
    .form-group textarea,
    .form-group select {
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border);
        border-radius: 0.55rem;
        font-size: 0.82rem;
        transition: all 0.16s ease-out;
        background: #f9fafb;
        color: var(--text);
    }

    .form-input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
        outline: none;
        border-color: rgba(79, 70, 229, 0.8);
        box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.45);
        background: white;
    }

    .form-group textarea {
        resize: vertical;
        min-height: 60px;
    }

    /* =========================
       RESPONSIVE
    ==========================*/
    @@media (max-width: 1024px) {
        .stats-grid {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        .filters-bar {
            flex-direction: column;
            align-items: stretch;
        }

        .filter-group {
            min-width: 100%;
        }
    }

    @@media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .form-grid.cols-2 {
            grid-template-columns: 1fr;
        }

        .header-compact {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.6rem;
        }

        .header-actions {
            width: 100%;
            justify-content: flex-start;
            flex-wrap: wrap;
        }
        
        .modal-overlay {
            padding: 0.5rem;
        }
        
        .modal-content {
            max-height: 95vh;
        }
        
        .modal-content.modal-sm,
        .modal-content.modal-md,
        .modal-content.modal-lg {
            max-width: 100%;
        }
        
        .modal-header,
        .modal-body,
        .modal-footer {
            padding: 1rem;
        }
    }
    
    .loading-indicator { display: inline-flex; align-items: center; gap: 0.5rem; color: var(--text-muted); }
    .loading-indicator.hidden { display: none; }
    .spinner { width: 16px; height: 16px; border: 2px solid var(--primary-soft); border-top-color: var(--primary); border-radius: 50%; animation: spin .8s linear infinite; }
    @@keyframes spin { to { transform: rotate(360deg); } }
    @@keyframes bgShift { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(12deg); } }
    @@keyframes orbit { 0%,100% { transform: translate(0,0) } 25% { transform: translate(2px,-2px) } 50% { transform: translate(0,-3px) } 75% { transform: translate(-2px,-2px) } }
.modal-template{display:none !important;}
</style>

<div class="container-inventory">

    <!-- NOTIFICACIONES -->
    @if (TempData["Success"] != null)
    {
        <div class="notification success">
            <div class="notification-content">
                <svg class="notification-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: var(--success);">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div class="notification-body">
                    <div class="notification-title">¡Éxito!</div>
                    <div class="notification-message">@TempData["Success"]</div>
                </div>
            </div>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="notification error">
            <div class="notification-content">
                <svg class="notification-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: var(--danger);">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div class="notification-body">
                    <div class="notification-title">Error</div>
                    <div class="notification-message">@TempData["Error"]</div>
                </div>
            </div>
        </div>
    }

    <!-- HEADER -->
    <div class="header-compact">
        <h1 class="header-title">
            Gestion de Inventario
        </h1>
        <div class="header-actions">
            <button type="button" onclick="return abrirModalNuevoMovimiento(event)" class="btn-premium btn-primary" title="Registrar nuevo movimiento">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Nuevo Movimiento
            </button>
            <button type="button" onclick="return abrirModalCrear(event)" class="btn-premium btn-success">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Producto
            </button>
            <button type="button" onclick="return exportarCSV()" class="btn-premium btn-muted">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v10m8-10v10M4 17h16M4 7h16"></path>
                </svg>
                Exportar CSV
            </button>
        </div>
    </div>

    <!-- ESTADÍSTICAS -->
    <div class="stats-grid">
        <div class="stat-card-mini primary">
            <div class="stat-label">Productos</div>
            <div class="stat-value">@Model.Estadisticas.TotalProductos</div>
            <div class="stat-meta">@Model.Estadisticas.UnidadesTotales unidades</div>
        </div>

        <div class="stat-card-mini success">
            <div class="stat-label">Valor Total</div>
            <div class="stat-value">S/ @Model.Estadisticas.ValorTotalInventario.ToString("N0")</div>
            <div class="stat-meta">@Model.Estadisticas.PorcentajeMargen% margen</div>
        </div>

        <div class="stat-card-mini info">
            <div class="stat-label">Stock Normal</div>
            <div class="stat-value">@Model.Estadisticas.ProductosStockNormal</div>
            <div class="stat-meta">En orden</div>
        </div>

        <div class="stat-card-mini warning">
            <div class="stat-label">Stock Bajo</div>
            <div class="stat-value">@Model.Estadisticas.ProductosStockBajo</div>
            <div class="stat-meta">Requiere atención</div>
        </div>

        <div class="stat-card-mini danger">
            <div class="stat-label">Sin Stock</div>
            <div class="stat-value">@Model.Estadisticas.ProductosSinStock</div>
            <div class="stat-meta">Crítico</div>
        </div>
    </div>

    <!-- TABS -->
    <div class="tabs-container">
        <a class="tab-btn @(Model.VistaActual=="productos"?"active":"")" id="tab-productos" href="?vista=productos">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
            </svg>
            Productos
        </a>
        <a class="tab-btn @(Model.VistaActual=="movimientos"?"active":"")" id="tab-movimientos" href="?vista=movimientos">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
            Movimientos
        </a>
    </div>

    <!-- TAB: PRODUCTOS -->
    <div id="content-productos" class="tab-content @(Model.VistaActual=="productos"?"":"hidden")">
        <!-- Filtros -->
        <div class="filters-bar">
            <form method="get" class="w-full" style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                <div class="filter-group" style="flex: 2; min-width: 200px;">
                    <label class="filter-label">Buscar</label>
                    <input id="inputBusqueda" type="text" name="busqueda" value="@Model.Busqueda" placeholder="Código o nombre..." class="filter-input">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Categoría</label>
                    <select name="categoriaId" class="filter-input">
                        <option value="">Todas</option>
                        @foreach (var c in Model.Categorias)
                        {
                            <option value="@c.IdCategoriaProducto" selected="@(Model.CategoriaId == c.IdCategoriaProducto)">@c.Nombre</option>
                        }
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Estado</label>
                    <select name="estadoStock" class="filter-input">
                        <option value="">Todos</option>
                        <option value="normal" selected="@(Model.EstadoStock == "normal")">Normal</option>
                        <option value="bajo" selected="@(Model.EstadoStock == "bajo")">Bajo</option>
                        <option value="sinstock" selected="@(Model.EstadoStock == "sinstock")">Sin Stock</option>
                    </select>
                </div>
                <div class="filter-group" style="min-width: auto;">
                    <label class="filter-label">&nbsp;</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <label style="display: flex; align-items: center; gap: 0.375rem; font-size: 0.75rem; white-space: nowrap;">
                            <input type="checkbox" name="showInactive" value="true" @(Model.ShowInactive ? "checked" : "")>
                            Inactivos
                        </label>
                        <div id="loadingIndicator" class="loading-indicator hidden"><span class="spinner"></span> Cargando...</div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Tabla -->
        <div class="content-area">
            <div class="table-container">
                <table class="table-premium">
                    <thead>
                        <tr>
                            <th style="width: 100px;">Código</th>
                            <th>Producto</th>
                            <th style="width: 120px;">Categoría</th>
                            <th style="width: 90px; text-align: right;">P. Compra</th>
                            <th style="width: 90px; text-align: right;">P. Venta</th>
                            <th style="width: 120px; text-align: center;">Stock</th>
                            <th style="width: 100px; text-align: center;">Estado</th>
                            <th style="width: 110px; text-align: right;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="productosTbody">
                        @if (Model.Productos.Any())
                        {
                            @foreach (var p in Model.Productos)
                            {
                                <tr>
                                    <td><span class="code-badge">@p.Codigo</span></td>
                                    <td>
                                        <div style="font-weight: 700; margin-bottom: 2px;">@p.Nombre</div>
                                        @if (!string.IsNullOrEmpty(p.Descripcion))
                                        {
                                            <div style="font-size: 0.7rem; color: var(--text-muted); max-width: 320px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">@p.Descripcion</div>
                                        }
                                    </td>
                                    <td><span class="badge badge-primary">@(p.CategoriaProducto?.Nombre ?? "Sin categoría")</span></td>
                                    <td style="text-align: right; color: var(--text-muted);">S/ @p.PrecioCompra.ToString("N2")</td>
                                    <td style="text-align: right; font-weight: 700; color: var(--success);">S/ @p.PrecioVenta.ToString("N2")</td>
                                    <td style="text-align: center;">
                                        <div class="stock-display">
                                            <div class="stock-value">@p.StockActual</div>
                                            <button type="button" onclick="return abrirModalAjustarStock(event, @p.IdProducto, '@p.Nombre', @p.StockActual)" class="stock-action">Ajustar</button>
                                            <div class="stock-min">Mín: @p.StockMinimo</div>
                                        </div>
                                    </td>
                                    <td style="text-align: center;">
                                        @if (p.StockActual == 0)
                                        {
                                            <span class="badge badge-danger">
                                                <span class="badge-dot" style="background: var(--danger);"></span>
                                                Sin Stock
                                            </span>
                                        }
                                        else if (p.StockBajo)
                                        {
                                            <span class="badge badge-warning">
                                                <span class="badge-dot" style="background: var(--warning);"></span>
                                                Bajo
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge badge-success">
                                                <span class="badge-dot" style="background: var(--success);"></span>
                                                Normal
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        <div class="actions-group" style="justify-content: flex-end; gap: .25rem;">
                                            <button type="button" onclick="return abrirMovimientosProducto(event, this)" class="btn-action stock" title="Ver Movimientos" data-id="@p.IdProducto" data-nombre="@p.Nombre">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path></svg>
                                            </button>
                                            <button type="button" onclick="return abrirEditarProductoLocal(event, this)" class="btn-action edit" title="Editar"
                                                    data-id="@p.IdProducto" data-codigo="@p.Codigo" data-nombre="@p.Nombre" data-descripcion="@p.Descripcion"
                                                    data-pcompra="@p.PrecioCompra" data-pventa="@p.PrecioVenta" data-stockactual="@p.StockActual" data-stockminimo="@p.StockMinimo"
                                                    data-categoria="@p.IdCategoriaProducto">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                </svg>
                                            </button>
                                            <button type="button" onclick="toggleProducto(@p.IdProducto, '@p.Nombre', @(@p.Activo ? "true" : "false"))" class="btn-action power" title="Activar/Desactivar">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2v4m0 12v4m8-8H4" />
                                                </svg>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="8">
                                    <div class="empty-state">
                                        <svg class="empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                        </svg>
                                        <div class="empty-title">No hay productos</div>
                                        <div class="empty-message">
                                            @if (!string.IsNullOrWhiteSpace(Model.Busqueda) || Model.CategoriaId.HasValue)
                                            {
                                                <text>Ajusta los filtros o crea un nuevo producto</text>
                                            }
                                            else
                                            {
                                                <text>Comienza agregando tu primer producto</text>
                                            }
                                        </div>
                                        <button type="button" onclick="return abrirModalCrear(event)" class="btn-premium btn-primary">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                            </svg>
                                            Crear Producto
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- TAB: MOVIMIENTOS -->
    <div id="content-movimientos" class="tab-content @(Model.VistaActual=="movimientos"?"":"hidden")">
        <div class="content-area">
            <div class="filters-bar" style="display:flex; gap:.75rem; align-items:flex-end; margin-bottom: .75rem; flex-wrap:wrap;">
                <div class="filter-group" style="flex:2; min-width: 220px;">
                    <label class="filter-label">Buscar por producto</label>
                    <input id="movBuscar" type="text" placeholder="Nombre de producto..." class="filter-input">
                </div>
                <div class="filter-group" style="flex:1; min-width:180px;">
                    <label class="filter-label">Desde</label>
                    <input id="movDesde" type="date" class="filter-input">
                </div>
                <div class="filter-group" style="flex:1; min-width:180px;">
                    <label class="filter-label">Hasta</label>
                    <input id="movHasta" type="date" class="filter-input">
                </div>
            </div>
            <div id="movimientosLista">
            @if (Model.Movimientos.Any())
            {
                @foreach (var m in Model.Movimientos)
                {
                    <div class="movement-card">
                        <div class="movement-header">
                            <div class="movement-icon @(m.TipoMovimiento?.Nombre?.ToLower().Contains("entrada") == true ? "entrada" : "salida")">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    @if (m.TipoMovimiento?.Nombre?.ToLower().Contains("entrada") == true)
                                    {
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12"></path>
                                    }
                                    else
                                    {
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6"></path>
                                    }
                                </svg>
                            </div>
                            <div class="movement-details">
                                <div class="movement-product">@(m.Producto?.Nombre ?? "Producto desconocido")</div>
                                <div class="movement-meta">
                                    <span>@m.Fecha.ToString("dd/MM/yyyy HH:mm")</span>
                                    <span>Cantidad: <strong>@m.Cantidad</strong></span>
                                    @if (!string.IsNullOrEmpty(m.Observacion))
                                    {
                                        <span>@m.Observacion</span>
                                    }
                                </div>
                            </div>
                            <span class="badge @(m.TipoMovimiento?.Nombre?.ToLower().Contains("entrada") == true ? "badge-success" : "badge-danger")">
                                @(m.TipoMovimiento?.Nombre ?? "Sin tipo")
                            </span>
                            <button type="button" class="btn-action edit" title="Editar" onclick="return abrirEditarMovimiento(event, @m.IdMovimiento, '@(m.Observacion ?? "")', @m.Cantidad, '@(m.TipoMovimiento?.Nombre ?? "")')">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            </button>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="empty-state">
                    <svg class="empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    <div class="empty-title">Sin movimientos</div>
                    <div class="empty-message">Los movimientos de inventario aparecerán aquí</div>
                </div>
            }
            </div>
        </div>
    </div>
</div>

<!-- El contenedor de modal global está en el layout (_LayoutSidebar) -->

<!-- MODAL: MOVIMIENTOS POR PRODUCTO (TPL) -->
<div id="tplMovimientosProducto" class="modal-template" style="display:none">
    <div class="modal-content modal-md" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 class="modal-title">Movimientos</h3>
            <button type="button" onclick="Modal.close('crudModal')" class="btn-action">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div class="modal-body">
            <div id="movsHeader" style="font-weight:700; margin-bottom:.5rem;"></div>
            <table class="table-premium">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Tipo</th>
                        <th class="text-center">Cantidad</th>
                        <th>Observación</th>
                        <th class="text-right">Costo</th>
                        <th style="width:80px; text-align:right;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="movsTbody"></tbody>
            </table>
        </div>
        <div class="modal-footer">
            <button type="button" onclick="Modal.close('crudModal')" class="btn-premium btn-muted">Cerrar</button>
        </div>
    </div>
</div>

<!-- MODAL: PRODUCTO -->
<div id="tplProducto" class="modal-template" style="display:none">
    <div class="modal-content modal-lg" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 id="modalTitulo" class="modal-title">Nuevo Producto</h3>
            <button type="button" onclick="Modal.close('crudModal')" class="btn-action">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <form id="formProducto" method="post">
            @Html.AntiForgeryToken()
            <div class="modal-body">
                <input type="hidden" id="productoId" name="id" value="0">
                <div class="form-grid cols-2">
                    <div class="form-group">
                        <label class="form-label">Código <span class="required">*</span></label>
                        <input type="text" id="codigo" name="codigo" required maxlength="20" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Categoría</label>
                        <select id="categoriaId" name="categoriaId" class="form-input">
                            <option value="">Sin categoría</option>
                            @foreach (var c in Model.Categorias)
                            {
                                <option value="@c.IdCategoriaProducto">@c.Nombre</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Nombre <span class="required">*</span></label>
                        <input type="text" id="nombre" name="nombre" required maxlength="100" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Descripción</label>
                        <textarea id="descripcion" name="descripcion" rows="2" maxlength="500" class="form-input"></textarea>
                    </div>
                </div>
                <div class="form-grid cols-2">
                    <div class="form-group">
                        <label class="form-label">Precio Compra <span class="required">*</span></label>
                        <input type="number" id="precioCompra" name="precioCompra" required step="0.01" min="0" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Precio Venta <span class="required">*</span></label>
                        <input type="number" id="precioVenta" name="precioVenta" required step="0.01" min="0" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Stock Actual <span class="required">*</span></label>
                        <input type="number" id="stockActual" name="stockActual" required min="0" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Stock Mínimo <span class="required">*</span></label>
                        <input type="number" id="stockMinimo" name="stockMinimo" required min="0" class="form-input">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="Modal.close('crudModal')" class="btn-premium btn-muted">Cancelar</button>
                <button type="submit" class="btn-premium btn-primary">Guardar Producto</button>
            </div>
        </form>
    </div>
</div>

<!-- MODAL: AJUSTAR STOCK -->
<div id="tplAjustarStock" class="modal-template" style="display:none">
    <div class="modal-content modal-sm" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div>
                <h3 class="modal-title">Ajustar Stock</h3>
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;" id="productoNombreStock"></div>
            </div>
            <button type="button" onclick="Modal.close('crudModal')" class="btn-action">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <form id="formAjustarStock" method="post" asp-page-handler="AjustarStock">
            <div class="modal-body">
                <input type="hidden" id="ajustarProductoId" name="id">

                <div style="background: var(--surface-dark); border-radius: 0.7rem; padding: 1.5rem; text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 0.68rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.5rem;">Stock Actual</div>
                    <div style="font-size: 3rem; font-weight: 800; color: var(--primary); line-height: 1;" id="stockActualDisplay"></div>
                    <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem;">unidades</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Cantidad <span class="required">*</span></label>
                    <input type="number" id="ajustarCantidad" name="cantidad" required min="1" value="1" class="form-input" style="text-align: center; font-size: 1.25rem; font-weight: 700;">
                </div>

                <div class="form-group">
                    <label class="form-label">Tipo de Movimiento <span class="required">*</span></label>
                    <input type="hidden" name="tipo" id="ajustarTipo" value="entrada">
                    <div class="type-selector">
                        <input type="radio" id="rbEntradaAjuste" name="tipoRadio" value="entrada" checked style="display:none">
                        <label for="rbEntradaAjuste" class="type-btn entrada active" id="lblEntradaAjuste">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12"></path>
                            </svg>
                            Entrada
                        </label>
                        
                        <input type="radio" id="rbSalidaAjuste" name="tipoRadio" value="salida" style="display:none">
                        <label for="rbSalidaAjuste" class="type-btn salida" id="lblSalidaAjuste">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6"></path>
                            </svg>
                            Salida
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="Modal.close('crudModal')" class="btn-premium btn-muted">Cancelar</button>
                <button type="submit" class="btn-premium btn-primary">Confirmar Ajuste</button>
            </div>
        </form>
    </div>
</div>

<!-- MODAL: NUEVO MOVIMIENTO -->
<div id="tplNuevoMovimiento" class="modal-template" style="display:none">
    <div class="modal-content modal-md" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 class="modal-title">Registrar Movimiento</h3>
            <button type="button" onclick="Modal.close('crudModal')" class="btn-action">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <form method="post" asp-page-handler="AjustarStock">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Producto <span class="required">*</span></label>
                    <input type="text" id="nuevoMovProductoBuscar" class="form-input" placeholder="Escribe nombre o código..." />
                    <input type="hidden" name="id" id="nuevoMovProductoId" />
                    <div id="nuevoMovSug" class="suggest-box" style="position:relative;">
                        <div id="nuevoMovSugList" class="suggest-list" style="position:absolute; left:0; right:0; z-index:9; background: var(--surface); border: 1px solid var(--border); border-radius: .5rem; max-height: 180px; overflow:auto; display:none;"></div>
                    </div>
                    <ul id="nuevoMovAll" style="display:none;">
                        @foreach (var p in Model.ProductosSeleccion)
                        {
                            <li data-id="@p.IdProducto" data-pcompra="@p.PrecioCompra" data-pventa="@p.PrecioVenta" data-text="@p.Nombre (@p.Codigo) - Stock: @p.StockActual"></li>
                        }
                    </ul>
                </div>

                <div class="form-group">
                    <label class="form-label">Cantidad <span class="required">*</span></label>
                    <input type="number" name="cantidad" id="nuevoMovCantidad" required min="1" value="1" class="form-input" style="text-align: center; font-size: 1.25rem; font-weight: 700;">
                </div>

                <div class="form-group">
                    <label class="form-label">Tipo de Movimiento <span class="required">*</span></label>
                    <input type="hidden" name="tipo" id="nuevoMovTipo" value="entrada">
                    <div class="type-selector">
                        <input type="radio" id="rbEntradaNuevo" name="tipoNuevo" value="entrada" checked onchange="seleccionarTipoNuevo('entrada')" style="display:none">
                        <label for="rbEntradaNuevo" class="type-btn entrada active" id="lblEntradaNuevo">Entrada</label>
                        <input type="radio" id="rbSalidaNuevo" name="tipoNuevo" value="salida" onchange="seleccionarTipoNuevo('salida')" style="display:none">
                        <label for="rbSalidaNuevo" class="type-btn salida" id="lblSalidaNuevo">Salida</label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Costo Unitario</label>
                    <input type="number" name="costoUnitario" id="nuevoMovCostoUnitario" step="0.01" min="0" class="form-input" placeholder="Sugerido: precio de compra">
                </div>

                <div class="form-group">
                    <label class="form-label">Observaciones</label>
                    <textarea name="observacion" id="nuevoMovObservacion" rows="2" maxlength="300" class="form-input" placeholder="Detalle del movimiento"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Fecha</label>
                    <input type="datetime-local" name="fecha" id="nuevoMovFecha" class="form-input">
                </div>

                <div class="form-group" style="font-size:.9rem; color: var(--text-muted);">
                    <span>Total estimado: </span>
                    <strong id="nuevoMovTotal" style="color: var(--success);">S/ 0.00</strong>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="Modal.close('crudModal')" class="btn-premium btn-muted">Cancelar</button>
                <button type="submit" class="btn-premium btn-primary">Registrar Movimiento</button>
            </div>
        </form>
    </div>
</div>

<!-- MODAL: EDITAR MOVIMIENTO -->
<div id="tplEditarMovimiento" class="modal-template" style="display:none">
    <div class="modal-content modal-sm" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 class="modal-title">Editar Movimiento</h3>
            <button type="button" onclick="Modal.close('crudModal')" class="btn-action">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="movEditId">
            <div class="form-group">
                <label class="form-label">Cantidad</label>
                <input type="number" id="movEditCantidad" min="1" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Tipo</label>
                <select id="movEditTipo" class="form-input">
                    <option value="entrada">Entrada</option>
                    <option value="salida">Salida</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Observaciones</label>
                <textarea id="movEditObs" rows="2" maxlength="300" class="form-input"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" onclick="Modal.close('crudModal')" class="btn-premium btn-muted">Cancelar</button>
            <button type="button" onclick="guardarEdicionMovimientoTpl()" class="btn-premium btn-primary">Guardar</button>
        </div>
    </div>
    
</div>

@section Scripts {
<script>
const debounce = (fn, ms = 300) => { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); }; };

function abrirModalCrear(e) {
    if (e) { e.preventDefault?.(); e.stopPropagation?.(); e.stopImmediatePropagation?.(); }
    return openInCrud('#tplProducto', (root) => {
        const title = root.querySelector('#modalTitulo'); if (title) title.textContent = 'Nuevo Producto';
        const form = root.querySelector('#formProducto'); if (form) form.action = '?handler=Crear';
        const set = id => { const el = root.querySelector('#' + id); if (el) el.value = ''; };
        ['productoId','codigo','nombre','descripcion','precioCompra','precioVenta','stockActual','stockMinimo'].forEach(set);
        const cat = root.querySelector('#categoriaId'); if (cat) cat.value = '';
        setTimeout(() => root.querySelector('#codigo')?.focus(), 10);
    });
}

function abrirModalAjustarStock(e, id, nombre, stock) {
    if (e) { e.preventDefault?.(); e.stopPropagation?.(); e.stopImmediatePropagation?.(); }
    
    return openInCrud('#tplAjustarStock', (root) => {
        const setText = (sel, val) => { const el = root.querySelector(sel); if (el) el.textContent = val; };
        const setVal = (sel, val) => { const el = root.querySelector(sel); if (el) el.value = val; };
        
        // Establecer valores
        setVal('#ajustarProductoId', id);
        setText('#productoNombreStock', nombre);
        setText('#stockActualDisplay', stock);
        setVal('#ajustarCantidad', '1');
        
        // Inicializar tipo
        const tipo = root.querySelector('#ajustarTipo'); 
        if (tipo) tipo.value = 'entrada';
        
        const rbE = root.querySelector('#rbEntradaAjuste'); 
        const rbS = root.querySelector('#rbSalidaAjuste');
        if (rbE) rbE.checked = true; 
        if (rbS) rbS.checked = false;
        
        // Pasar root al inicializar
        seleccionarTipoAjuste('entrada', root);
        
        // Agregar event listeners para cambiar tipo
        const lblEntrada = root.querySelector('#lblEntradaAjuste');
        const lblSalida = root.querySelector('#lblSalidaAjuste');
        
        if (lblEntrada) {
            lblEntrada.addEventListener('click', function() {
                if (rbE) rbE.checked = true;
                if (rbS) rbS.checked = false;
                seleccionarTipoAjuste('entrada', root);
            });
        }
        
        if (lblSalida) {
            lblSalida.addEventListener('click', function() {
                if (rbS) rbS.checked = true;
                if (rbE) rbE.checked = false;
                seleccionarTipoAjuste('salida', root);
            });
        }
        
        if (rbE) {
            rbE.addEventListener('change', function() {
                if (this.checked) seleccionarTipoAjuste('entrada', root);
            });
        }
        
        if (rbS) {
            rbS.addEventListener('change', function() {
                if (this.checked) seleccionarTipoAjuste('salida', root);
            });
        }
        
        // Focus en cantidad
        setTimeout(() => {
            const cantInput = root.querySelector('#ajustarCantidad');
            cantInput?.focus();
            cantInput?.select();
        }, 150);
    });
}

function abrirModalNuevoMovimiento(e) {
    if (e) { e.preventDefault?.(); e.stopPropagation?.(); e.stopImmediatePropagation?.(); }
    
    return openInCrud('#tplNuevoMovimiento', (root) => {
        // Inicializar tipo
        seleccionarTipoNuevo('entrada', root);
        
        // Event listeners para tipo
        root.querySelector('#lblEntradaNuevo')?.addEventListener('click', () => seleccionarTipoNuevo('entrada', root));
        root.querySelector('#lblSalidaNuevo')?.addEventListener('click', () => seleccionarTipoNuevo('salida', root));
        
        const rbNE = root.querySelector('#rbEntradaNuevo');
        const rbNS = root.querySelector('#rbSalidaNuevo');
        rbNE?.addEventListener('change', () => seleccionarTipoNuevo('entrada', root));
        rbNS?.addEventListener('change', () => seleccionarTipoNuevo('salida', root));
        
        // Inicializar fecha
        const fecha = root.querySelector('#nuevoMovFecha');
        if (fecha) {
            const d = new Date();
            const iso = new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,16);
            fecha.value = iso;
        }
        
        // Referencias a elementos
        const buscar = root.querySelector('#nuevoMovProductoBuscar');
        const sugList = root.querySelector('#nuevoMovSugList');
        const hiddenId = root.querySelector('#nuevoMovProductoId');
        const costo = root.querySelector('#nuevoMovCostoUnitario');
        const cant = root.querySelector('#nuevoMovCantidad');
        const total = root.querySelector('#nuevoMovTotal');
        
        // Cargar todos los productos disponibles
        const allItems = Array.from(root.querySelectorAll('#nuevoMovAll li')).map(li => ({
            id: li.getAttribute('data-id'),
            text: li.getAttribute('data-text') || '',
            pcompra: li.getAttribute('data-pcompra') || '',
            pventa: li.getAttribute('data-pventa') || ''
        }));
        
        console.log('✅ Productos cargados:', allItems.length); // DEBUG
        
        // Calcular total
        const calc = () => {
            const c = parseFloat(cant?.value || '0');
            const u = parseFloat(costo?.value || '0');
            if (total) total.textContent = 'S/ ' + (isNaN(c)||isNaN(u) ? '0.00' : (c*u).toFixed(2));
        };
        
        // Mostrar sugerencias
        const showSug = (items) => {
            console.log('📋 Mostrando sugerencias:', items.length); // DEBUG
            
            if (!sugList) {
                console.error('❌ sugList no encontrado');
                return;
            }
            
            if (!items.length) {
                sugList.style.display = 'none';
                sugList.innerHTML = '';
                return;
            }
            
            sugList.innerHTML = items.map(it => 
                `<div class="suggest-item" data-id="${it.id}" data-pcompra="${it.pcompra}" data-pventa="${it.pventa}">
                    ${it.text}
                </div>`
            ).join('');
            
            sugList.style.display = 'block';
            
            // Agregar eventos click a cada item
            sugList.querySelectorAll('.suggest-item').forEach(el => {
                el.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const text = this.textContent.trim();
                    const pcompra = this.getAttribute('data-pcompra') || '';
                    const pventa = this.getAttribute('data-pventa') || '';
                    
                    console.log('✅ Producto seleccionado:', text); // DEBUG
                    
                    if (hiddenId) {
                        hiddenId.value = id;
                        hiddenId.dataset.pcompra = pcompra;
                        hiddenId.dataset.pventa = pventa;
                    }
                    if (buscar) buscar.value = text;
                    if (costo && pcompra) costo.value = pcompra;
                    
                    sugList.style.display = 'none';
                    calc();
                });
            });
        };
        
        // Buscar con debounce
        const fetchSug = debounce(async () => {
            const q = (buscar?.value || '').trim();
            
            console.log('🔍 Buscando:', q); // DEBUG
            
            if (!q) {
                showSug([]);
                return;
            }
            
            try {
                const params = new URLSearchParams();
                params.set('term', q);
                
                const res = await fetch(`?handler=BuscarProductos&${params.toString()}`);
                const data = await res.json();
                
                console.log('📦 Respuesta API:', data); // DEBUG
                
                if (!data.success) {
                    showSug([]);
                    return;
                }
                
                const items = (data.productos || []).map(p => ({
                    id: p.idProducto,
                    text: `${p.nombre} (${p.codigo}) - Stock: ${p.stockActual}`,
                    pcompra: p.precioCompra,
                    pventa: p.precioVenta
                }));
                
                showSug(items);
            } catch (err) {
                console.error('❌ Error en búsqueda:', err); // DEBUG
                
                // Fallback: filtrar localmente
                const ql = q.toLowerCase();
                const filtered = allItems.filter(x => x.text.toLowerCase().includes(ql));
                showSug(filtered);
            }
        }, 250);
        
        // EVENT LISTENER PRINCIPAL
        if (buscar) {
            console.log('✅ Agregando event listener al input'); // DEBUG
            
            buscar.addEventListener('input', function() {
                console.log('⌨️ Input detectado:', this.value); // DEBUG
                fetchSug();
            });
            
            // Navegación con teclado
            buscar.addEventListener('keydown', (e) => {
                if (!sugList || sugList.style.display === 'none') return;
                
                const items = Array.from(sugList.querySelectorAll('.suggest-item'));
                if (!items.length) return;
                
                let idx = items.findIndex(i => i.classList.contains('active'));
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    idx = Math.min(items.length - 1, idx + 1);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    idx = Math.max(0, idx - 1);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    (items[idx] || items[0]).click();
                    return;
                } else if (e.key === 'Escape') {
                    sugList.style.display = 'none';
                    return;
                }
                
                items.forEach(i => i.classList.remove('active'));
                if (idx >= 0) items[idx].classList.add('active');
                else items[0].classList.add('active');
            });
        }
        
        // Calcular cuando cambia cantidad o costo
        cant?.addEventListener('input', calc);
        costo?.addEventListener('input', calc);
        
        // Calcular inicial
        calc();
        
        // Focus al input de búsqueda
        setTimeout(() => buscar?.focus(), 150);
    });
}

// Usar handlers del Modal global del layout

function seleccionarTipoAjuste(tipo, root) {
    // Si no se pasa root, buscar en el modal activo
    const context = root || document.querySelector('#crudModal .modal-content');
    
    const entrada = context.querySelector('#lblEntradaAjuste');
    const salida = context.querySelector('#lblSalidaAjuste');
    const input = context.querySelector('#ajustarTipo');
    const rbE = context.querySelector('#rbEntradaAjuste');
    const rbS = context.querySelector('#rbSalidaAjuste');
    
    if (entrada && salida && input) {
        entrada.classList.remove('active');
        salida.classList.remove('active');
        input.value = tipo;
        
        if (tipo === 'entrada') { 
            entrada.classList.add('active'); 
            if (rbE) rbE.checked = true; 
            if (rbS) rbS.checked = false; 
        }
        else { 
            salida.classList.add('active'); 
            if (rbS) rbS.checked = true; 
            if (rbE) rbE.checked = false; 
        }
    }
}

function seleccionarTipoNuevo(tipo, root) {
    // Si no se pasa root, buscar en el modal activo
    const context = root || document.querySelector('#crudModal .modal-content');
    
    const entrada = context.querySelector('#lblEntradaNuevo');
    const salida = context.querySelector('#lblSalidaNuevo');
    const input = context.querySelector('#nuevoMovTipo');
    const hiddenId = context.querySelector('#nuevoMovProductoId');
    const costo = context.querySelector('#nuevoMovCostoUnitario');
    const rbE = context.querySelector('#rbEntradaNuevo');
    const rbS = context.querySelector('#rbSalidaNuevo');
    
    if (entrada && salida && input) {
        entrada.classList.remove('active');
        salida.classList.remove('active');
        input.value = tipo;
        
        if (tipo === 'entrada') { 
            entrada.classList.add('active'); 
            if (rbE) rbE.checked = true; 
            if (rbS) rbS.checked = false; 
        }
        else { 
            salida.classList.add('active'); 
            if (rbS) rbS.checked = true; 
            if (rbE) rbE.checked = false; 
        }
        
        const pc = hiddenId?.dataset?.pcompra || '';
        const pv = hiddenId?.dataset?.pventa || '';
        if (costo) costo.value = (tipo === 'entrada') ? pc : (pv || pc);
    }
}

function abrirEditarProductoLocal(e, btn) {
    if (e) { e.preventDefault?.(); e.stopPropagation?.(); e.stopImmediatePropagation?.(); }
    return openInCrud('#tplProducto', (root) => {
        const title = root.querySelector('#modalTitulo'); if (title) title.textContent = 'Editar Producto';
        const form = root.querySelector('#formProducto'); if (form) form.action = '?handler=Actualizar';
        const set = (idSel, val) => { const el = root.querySelector('#' + idSel); if (el) el.value = (val ?? ''); };
        set('productoId', btn.dataset.id);
        set('codigo', btn.dataset.codigo);
        set('nombre', btn.dataset.nombre);
        set('descripcion', btn.dataset.descripcion ? decodeURIComponent(btn.dataset.descripcion) : '');
        set('precioCompra', btn.dataset.pcompra);
        set('precioVenta', btn.dataset.pventa);
        set('stockActual', btn.dataset.stockactual);
        set('stockMinimo', btn.dataset.stockminimo);
        const cat = root.querySelector('#categoriaId'); if (cat) cat.value = btn.dataset.categoria || '';
        setTimeout(() => root.querySelector('#nombre')?.focus(), 10);
    });
}

function confirmarEliminar(id, nombre) {
    if (confirm(`¿Está seguro que desea eliminar el producto "${nombre}"?\n\nEsta acción desactivará el producto.`)) {
        const form = document.createElement('form');
        form.method = 'post';
        form.action = '?handler=Eliminar';
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'id';
        input.value = id;
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }
}

async function abrirMovimientosProducto(e, btn) {
    if (e) { e.preventDefault?.(); e.stopPropagation?.(); e.stopImmediatePropagation?.(); }
    return openInCrud('#tplMovimientosProducto', async (root) => {
        const id = btn.dataset.id; const nombre = btn.dataset.nombre;
        const header = root.querySelector('#movsHeader'); if (header) header.textContent = `Producto: ${nombre}`;
        const tbody = root.querySelector('#movsTbody'); if (!tbody) return;
        tbody.innerHTML = `<tr><td colspan="6" class="text-center">Cargando...</td></tr>`;
        try {
            const url = window.location.pathname + `?handler=MovimientosProducto&id=${id}`;
            const res = await fetch(url);
            const data = await res.json();
            if (!data.success || !data.movimientos?.length) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center">Sin movimientos</td></tr>`;
                return;
            }
            tbody.innerHTML = data.movimientos.map(m => `<tr>
                <td>${m.fecha}</td>
                <td><span class="badge ${m.tipo?.toLowerCase().includes('entrada') ? 'badge-success' : 'badge-warning'}">${m.tipo}</span></td>
                <td class="text-center">${m.cantidad}</td>
                <td>${m.observacion || ''}</td>
                <td class="text-right">S/ ${Number(m.costoTotal).toFixed(2)}</td>
                <td class="text-right"><button type="button" class="btn-action edit" title="Editar" onclick="return abrirEditarMovimiento(event, ${m.idMovimiento}, '${(m.observacion||'').replace(/'/g, "\\'")}', ${m.cantidad}, '${(m.tipo||'').replace(/'/g, "\\'")}')"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button></td>
            </tr>`).join('');
        } catch (err) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center">Error al cargar</td></tr>`;
        }
    });
}

function abrirEditarMovimiento(e, idMovimiento, observacion, cantidad, tipo) {
    if (e) { e.preventDefault?.(); e.stopPropagation?.(); }
    return openInCrud('#tplEditarMovimiento', (root) => {
        const setVal = (sel, val) => { const el = root.querySelector(sel); if (el) el.value = val; };
        setVal('#movEditId', idMovimiento);
        setVal('#movEditObs', observacion || '');
        setVal('#movEditCantidad', String(cantidad || 1));
        const tipoEl = root.querySelector('#movEditTipo'); if (tipoEl) tipoEl.value = (tipo || '').toLowerCase().includes('salida') ? 'salida' : 'entrada';
        setTimeout(() => root.querySelector('#movEditCantidad')?.focus(), 10);
    });
}

async function guardarEdicionMovimientoTpl() {
    const id = document.querySelector('#movEditId')?.value;
    const obs = document.querySelector('#movEditObs')?.value || '';
    const cantidad = parseInt(document.querySelector('#movEditCantidad')?.value || '0', 10);
    const tipo = document.querySelector('#movEditTipo')?.value || 'entrada';
    if (!id || !cantidad || cantidad < 1) return false;
    try {
        const formData = new URLSearchParams();
        formData.set('idMovimiento', id);
        formData.set('cantidad', String(cantidad));
        formData.set('tipo', tipo);
        formData.set('observacion', obs);
        const res = await fetch(`?handler=EditarMovimientoCompleto`, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: formData.toString() });
        const data = await res.json();
        if (data.success) {
            Modal.close('crudModal');
            return true;
        } else {
            alert(data.message || 'Error al guardar');
        }
    } catch (err) {
        alert('Error al guardar');
    }
}

function exportarCSV() {
    const tbody = document.getElementById('productosTbody');
    if (!tbody) return false;
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const data = [];
    for (const tr of rows) {
        const tds = tr.querySelectorAll('td');
        if (tds.length < 8) continue;
        const codigo = tds[0].textContent.trim();
        const nombre = tds[1].querySelector('div')?.textContent.trim() || '';
        const categoria = tds[2].textContent.trim();
        const pcompra = tds[3].textContent.trim().replace('S/', '').trim();
        const pventa = tds[4].textContent.trim().replace('S/', '').trim();
        const stock = tds[5].querySelector('.stock-value')?.textContent.trim() || '';
        const estado = tds[6].textContent.trim();
        data.push([codigo, nombre, categoria, pcompra, pventa, stock, estado]);
    }
    if (data.length === 0) return false;
    const header = ['Codigo', 'Nombre', 'Categoria', 'PrecioCompra', 'PrecioVenta', 'Stock', 'Estado'];
    const csv = [header, ...data].map(r => r.map(v => '"' + String(v).replace(/"/g, '""') + '"').join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'inventario.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    return false;
}

function cambiarTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
    const tabBtn = document.getElementById('tab-' + tab);
    const tabContent = document.getElementById('content-' + tab);
    if (tabBtn) tabBtn.classList.add('active');
    if (tabContent) tabContent.classList.remove('hidden');
}

function openInCrud(modalSelector, setupFn) {
    const src = document.querySelector(modalSelector + ' .modal-content');
    const target = document.getElementById('modalContent');
    if (!src || !target) return false;
    target.innerHTML = src.innerHTML;
    // normalizar SOLO botones que cierran
    target.querySelectorAll('button[onclick*="Modal.close"]')?.forEach(btn => { btn.setAttribute('onclick', "Modal.close('crudModal')"); });
    try { setupFn?.(target); } catch {}
    Modal.open('crudModal');
    return false;
}

document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        document.querySelectorAll('.notification').forEach(n => {
            n.style.transition = 'all 0.25s ease-out';
            n.style.opacity = '0';
            n.style.transform = 'translateX(120%)';
            setTimeout(() => n.remove(), 260);
        });
    }, 5000);
    const input = document.getElementById('inputBusqueda');
    input?.addEventListener('input', debounce(actualizarGrilla, 250));
    document.querySelector('select[name="categoriaId"]')?.addEventListener('change', actualizarGrilla);
    document.querySelector('select[name="estadoStock"]')?.addEventListener('change', actualizarGrilla);
    document.querySelector('input[name="showInactive"]')?.addEventListener('change', actualizarGrilla);
});

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        Modal.close('crudModal');
    }
    if (e.ctrlKey && (e.key === 'k' || e.key === 'K')) { e.preventDefault(); const input = document.getElementById('inputBusqueda'); input?.focus(); input?.select(); }
    if (e.ctrlKey && (e.key === 'n' || e.key === 'N')) { e.preventDefault(); abrirModalCrear(e); }
    if (e.ctrlKey && (e.key === 'm' || e.key === 'M')) { e.preventDefault(); abrirModalNuevoMovimiento(e); }
    if (e.ctrlKey && (e.key === 'e' || e.key === 'E')) { e.preventDefault(); exportarCSV(); }
});

// Listeners para filtros de movimientos
document.getElementById('movBuscar')?.addEventListener('input', debounce(actualizarMovimientos, 250));
document.getElementById('movDesde')?.addEventListener('change', actualizarMovimientos);
document.getElementById('movHasta')?.addEventListener('change', actualizarMovimientos);

async function actualizarMovimientos() {
    try {
        const producto = document.getElementById('movBuscar')?.value || '';
        const desde = document.getElementById('movDesde')?.value || '';
        const hasta = document.getElementById('movHasta')?.value || '';
        const params = new URLSearchParams();
        if (producto) params.set('producto', producto);
        if (desde) params.set('desde', desde);
        if (hasta) params.set('hasta', hasta);
        const res = await fetch(`?handler=FiltrarMovimientos&${params.toString()}`);
        const data = await res.json();
        const cont = document.getElementById('movimientosLista');
        if (!cont) return;
        if (!data.success) { cont.innerHTML = '<div class="empty-state"><div class="empty-title">Error</div></div>'; return; }
        if (!data.movimientos?.length) { cont.innerHTML = '<div class="empty-state"><div class="empty-title">Sin movimientos</div></div>'; return; }

        cont.innerHTML = data.movimientos.map(m => (
            '<div class="movement-card">'
            +'<div class="movement-header">'
                +'<div class="movement-icon '+(String(m.tipo).toLowerCase().includes('entrada') ? 'entrada' : 'salida')+'">'
                    +'<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">'
                        +(String(m.tipo).toLowerCase().includes('entrada')
                          ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12"></path>'
                          : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6"></path>')
                    +'</svg>'
                +'</div>'
                +'<div class="movement-details">'
                    +'<div class="movement-product">'+(m.producto || 'Producto desconocido')+'</div>'
                    +'<div class="movement-meta">'
                        +'<span>'+m.fecha+'</span>'
                        +'<span>Cantidad: <strong>'+m.cantidad+'</strong></span>'
                        +(m.observacion ? '<span>'+m.observacion+'</span>' : '')
                    +'</div>'
                +'</div>'
                +'<span class="badge '+(String(m.tipo).toLowerCase().includes('entrada') ? 'badge-success' : 'badge-danger')+'">'+m.tipo+'</span>'
                +'<button type="button" class="btn-action edit" title="Editar" onclick="return abrirEditarMovimiento(event, '+m.idMovimiento+', \''+(m.observacion||'').replace(/'/g, "\\'")+'\', '+m.cantidad+', \''+(m.tipo||'').replace(/'/g, "\\'")+'\')">'
                    +'<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>'
                +'</button>'
            +'</div>'
        +'</div>'
        )).join('');
    } catch (err) {
        const cont = document.getElementById('movimientosLista');
        if (cont) cont.innerHTML = '<div class="empty-state"><div class="empty-title">Error al cargar</div></div>';
    }
}
</script>
}

<script>

async function toggleProducto(id, nombre, activo) {
    try {
        const url = new URL(window.location.href);
        url.search = `?handler=ToggleActivo&id=${encodeURIComponent(id)}`;
        const res = await fetch(url.toString(), { method: 'GET', credentials: 'same-origin', headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' } });
        const data = await res.json();
        if (!data.success) { alert(data.message || 'Error'); return; }
        await actualizarGrilla();
    } catch (err) {
        alert('Error al cambiar estado');
    }
}

async function actualizarGrilla() {
    try {
        const params = new URLSearchParams();
        const q = document.getElementById('inputBusqueda')?.value || '';
        const cat = document.querySelector('select[name="categoriaId"]')?.value || '';
        const est = document.querySelector('select[name="estadoStock"]')?.value || '';
        const ina = document.querySelector('input[name="showInactive"]')?.checked ? 'true' : 'false';
        params.set('busqueda', q);
        if (cat) params.set('categoriaId', cat);
        if (est) params.set('estadoStock', est);
        params.set('showInactive', ina);
        const res = await fetch(`?handler=Filtrar&${params.toString()}`);
        const data = await res.json();
        const tbody = document.getElementById('productosTbody');
        if (!tbody) return;
        if (!data.success) { tbody.innerHTML = `<tr><td colspan="8" class="text-center">Error</td></tr>`; return; }
        const rows = (data.productos || []).map(p => `
            <tr>
                <td><span class="code-badge">${p.codigo}</span></td>
                <td>
                    <div style="font-weight:700; margin-bottom:2px;">${p.nombre}</div>
                    ${p.descripcion ? `<div style=\"font-size:.7rem; color: var(--text-muted); max-width: 320px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;\">${p.descripcion}</div>` : ''}
                </td>
                <td><span class="badge badge-primary">${p.categoriaNombre || 'Sin categoría'}</span></td>
                <td style="text-align:right; color: var(--text-muted);">S/ ${Number(p.precioCompra).toFixed(2)}</td>
                <td style="text-align:right; font-weight:700; color: var(--success);">S/ ${Number(p.precioVenta).toFixed(2)}</td>
                <td style="text-align:center;">
                    <div class="stock-display">
                        <div class="stock-value">${p.stockActual}</div>
                        <button type="button" onclick=\"return abrirModalAjustarStock(event, ${p.idProducto}, '${p.nombre.replace(/'/g, "\\'")}', ${p.stockActual})\" class="stock-action">Ajustar</button>
                        <div class="stock-min">Mín: ${p.stockMinimo}</div>
                    </div>
                </td>
                <td style="text-align:center;">
                    ${p.stockActual == 0 ? `<span class="badge badge-danger"><span class="badge-dot" style=\"background: var(--danger);\"></span>Sin Stock</span>` : (p.stockActual <= p.stockMinimo ? `<span class="badge badge-warning"><span class="badge-dot" style=\"background: var(--warning);\"></span>Bajo</span>` : `<span class="badge badge-success"><span class="badge-dot" style=\"background: var(--success);\"></span>Normal</span>`)}
                </td>
                <td>
                    <div class="actions-group" style="justify-content:flex-end; gap:.25rem;">
                        <button type="button" onclick=\"return abrirMovimientosProducto(event, this)\" class="btn-action stock" title="Ver Movimientos" data-id="${p.idProducto}" data-nombre="${p.nombre.replace(/'/g, "\\'")}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path></svg>
                        </button>
                        <button type="button" onclick=\"return abrirEditarProductoRemoto(${p.idProducto})\" class="btn-action edit" title="Editar">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        </button>
                        <button type="button" onclick=\"toggleProducto(${p.idProducto}, '${p.nombre.replace(/'/g, "\\'")}', 'true')\" class="btn-action power" title="Activar/Desactivar">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2v4m0 12v4m8-8H4" /></svg>
                        </button>
                    </div>
                </td>
            </tr>`).join('');
        tbody.innerHTML = rows || `<tr><td colspan="8" class="text-center">Sin resultados</td></tr>`;
    } catch (err) {
        const tbody = document.getElementById('productosTbody');
        if (tbody) tbody.innerHTML = `<tr><td colspan="8" class="text-center">Error al cargar</td></tr>`;
    }
}

</script>

<script>
async function abrirEditarProductoRemoto(id) {
    try {
        const url = window.location.pathname + `?handler=ObtenerProducto&id=${encodeURIComponent(id)}`;
        const res = await fetch(url);
        if (!res.ok) { alert('Error al cargar producto'); return; }
        const data = await res.json();
        if (!data.success || !data.producto) { alert(data.message || 'No encontrado'); return; }
        return openInCrud('#tplProducto', (root) => {
            const title = root.querySelector('#modalTitulo'); if (title) title.textContent = 'Editar Producto';
            const form = root.querySelector('#formProducto'); if (form) form.action = '?handler=Actualizar';
            const p = data.producto;
            const valOr = (obj, a, b) => obj[a] !== undefined ? obj[a] : obj[b];
            const set = (idSel, val) => { const el = root.querySelector('#' + idSel); if (el) el.value = (val == null ? '' : String(val)); };
            set('productoId', valOr(p,'IdProducto','idProducto'));
            set('codigo', valOr(p,'Codigo','codigo'));
            set('nombre', valOr(p,'Nombre','nombre'));
            set('descripcion', valOr(p,'Descripcion','descripcion'));
            set('precioCompra', valOr(p,'PrecioCompra','precioCompra'));
            set('precioVenta', valOr(p,'PrecioVenta','precioVenta'));
            set('stockActual', valOr(p,'StockActual','stockActual'));
            set('stockMinimo', valOr(p,'StockMinimo','stockMinimo'));
            const cat = root.querySelector('#categoriaId'); if (cat) cat.value = valOr(p,'IdCategoriaProducto','idCategoriaProducto') || '';
            setTimeout(() => root.querySelector('#nombre')?.focus(), 10);
        });
    } catch (err) {
        alert('Error al cargar producto');
    }
}
</script>
