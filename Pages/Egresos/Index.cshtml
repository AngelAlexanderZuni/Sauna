@page
@model ProyectoSaunaKalixto.Web.Pages.Egresos.IndexModel
@{
    ViewData["Title"] = "Egresos";
    Layout = "_LayoutSidebar";
}

<div class="flex-1 overflow-auto">
    <div class="p-6 space-y-6">
        <!-- Header -->
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-2xl font-bold tracking-tight" style="color: var(--foreground);">Egresos</h2>
                <p class="text-sm mt-1" style="color: var(--muted-foreground);">
                    Gestiona los gastos operativos del negocio
                </p>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="abrirModalTipos()" 
                        class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-md border transition-all hover:bg-muted/50" 
                        style="border-color: var(--border); color: var(--foreground);">
                    <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Gestionar Tipos
                </button>
                <button onclick="loadCreateEgresoForm()" 
                        class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-md transition-all hover:opacity-90 shadow-sm" 
                        style="background-color: var(--primary); color: var(--primary-foreground);">
                    <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Nuevo Egreso
                </button>
            </div>
        </div>

        <!-- Filters Card - Dinámicos -->
        <div class="card">
            <div class="p-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-xs font-medium mb-1.5" style="color: var(--foreground);">Fecha Inicio</label>
                        <input type="date" 
                               id="filtroFechaInicio"
                               value="@Model.FechaInicio?.ToString("yyyy-MM-dd")"
                               class="w-full px-3 py-2 text-sm border rounded-md focus:outline-none focus:ring-2 transition-all" 
                               style="border-color: var(--border); background-color: var(--background); color: var(--foreground); --tw-ring-color: var(--primary);">
                    </div>
                    <div>
                        <label class="block text-xs font-medium mb-1.5" style="color: var(--foreground);">Fecha Fin</label>
                        <input type="date" 
                               id="filtroFechaFin"
                               value="@Model.FechaFin?.ToString("yyyy-MM-dd")"
                               class="w-full px-3 py-2 text-sm border rounded-md focus:outline-none focus:ring-2 transition-all" 
                               style="border-color: var(--border); background-color: var(--background); color: var(--foreground); --tw-ring-color: var(--primary);">
                    </div>
                    <div>
                        <label class="block text-xs font-medium mb-1.5" style="color: var(--foreground);">Tipo de Egreso</label>
                        <select id="filtroTipoEgreso"
                                class="w-full px-3 py-2 text-sm border rounded-md focus:outline-none focus:ring-2 transition-all"
                                style="border-color: var(--border); background-color: var(--background); color: var(--foreground); --tw-ring-color: var(--primary);">
                            <option value="">Todos los tipos</option>
                            @foreach (var tipo in Model.TiposEgreso)
                            {
                                <option value="@tipo.IdTipoEgreso" selected="@(Model.IdTipoEgresoFiltro == tipo.IdTipoEgreso)">
                                    @tipo.Nombre
                                </option>
                            }
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium mb-1.5" style="color: var(--foreground);">Buscar Concepto</label>
                        <div class="relative">
                            <input type="text" 
                                   id="filtroConcepto"
                                   placeholder="Buscar por concepto..."
                                   class="w-full px-3 py-2 pl-9 text-sm border rounded-md focus:outline-none focus:ring-2 transition-all" 
                                   style="border-color: var(--border); background-color: var(--background); color: var(--foreground); --tw-ring-color: var(--primary);">
                            <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4" style="color: var(--muted-foreground);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                <div id="filtrosActivos" class="mt-3 items-center gap-2 flex-wrap hidden">
                    <span class="text-xs font-medium" style="color: var(--muted-foreground);">Filtros activos:</span>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="card p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs font-medium" style="color: var(--muted-foreground);">Total Gastado</p>
                        <p class="text-3xl font-bold mt-2" style="color: var(--destructive);">
                            S/ @Model.TotalEgresos.ToString("N2")
                        </p>
                    </div>
                    <div class="h-12 w-12 rounded-full flex items-center justify-center" style="background-color: oklch(from var(--destructive) l c h / 0.1);">
                        <svg class="h-6 w-6" style="color: var(--destructive);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="card p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs font-medium" style="color: var(--muted-foreground);">Total Registros</p>
                        <p class="text-3xl font-bold mt-2" style="color: var(--foreground);" data-contador-total>
                            @Model.Egresos.Count
                        </p>
                    </div>
                    <div class="h-12 w-12 rounded-full flex items-center justify-center" style="background-color: oklch(from var(--primary) l c h / 0.1);">
                        <svg class="h-6 w-6" style="color: var(--primary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="card p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs font-medium" style="color: var(--muted-foreground);">Período Activo</p>
                        <p class="text-lg font-semibold mt-2" style="color: var(--foreground);">
                            @if (Model.FechaInicio.HasValue && Model.FechaFin.HasValue)
                            {
                                var dias = (Model.FechaFin.Value - Model.FechaInicio.Value).Days;
                                <span>@dias días</span>
                            }
                            else
                            {
                                <span>Sin filtro</span>
                            }
                        </p>
                    </div>
                    <div class="h-12 w-12 rounded-full flex items-center justify-center" style="background-color: oklch(from var(--chart-2) l c h / 0.1);">
                        <svg class="h-6 w-6" style="color: var(--chart-2);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        @if (Model.Egresos.Any())
        {
            <!-- Table Card -->
            <div class="card">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="border-b" style="border-color: var(--border);">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--muted-foreground);">Fecha</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--muted-foreground);">Detalles</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--muted-foreground);">Usuario</th>
                                <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider" style="color: var(--muted-foreground);">Monto</th>
                                <th class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wider" style="color: var(--muted-foreground);">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y" style="border-color: var(--border);">
                            @foreach (var egreso in Model.Egresos)
                            {
                                <tr class="group transition-colors" style="cursor: pointer;"
                                    data-egreso-id="@egreso.IdCabEgreso"
                                    data-fecha="@egreso.Fecha.ToString("yyyy-MM-dd")"
                                    data-tipos="@string.Join(",", egreso.Detalles.Select(d => d.IdTipoEgreso))"
                                    onmouseover="this.style.backgroundColor='oklch(from var(--muted) l c h / 0.3)'" 
                                    onmouseout="this.style.backgroundColor='transparent'">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="h-10 w-10 rounded-full flex items-center justify-center mr-3" 
                                                 style="background-color: oklch(from var(--primary) l c h / 0.1);">
                                                <svg class="h-5 w-5" style="color: var(--primary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                </svg>
                                            </div>
                                            <div>
                                                <div class="text-sm font-medium" style="color: var(--foreground);">
                                                    @egreso.Fecha.ToString("dd/MM/yyyy")
                                                </div>
                                                <div class="text-xs" style="color: var(--muted-foreground);">
                                                    @egreso.Fecha.ToString("HH:mm")
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="space-y-2">
                                            @foreach (var detalle in egreso.Detalles)
                                            {
                                                <div class="flex items-start gap-2">
                                                    <div class="h-5 w-5 rounded-full flex items-center justify-center flex-shrink-0" 
                                                         style="background-color: oklch(from var(--primary) l c h / 0.1);">
                                                        <svg class="h-3 w-3" style="color: var(--primary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                                        </svg>
                                                    </div>
                                                    <div class="flex-1 min-w-0">
                                                        <div class="text-sm font-medium concepto-text" style="color: var(--foreground);">
                                                            @detalle.Concepto
                                                        </div>
                                                        <div class="flex items-center gap-2 mt-0.5">
                                                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium"
                                                                  style="background-color: oklch(from var(--primary) l c h / 0.1); color: var(--primary);">
                                                                @detalle.NombreTipoEgreso
                                                            </span>
                                                            <span class="text-xs font-semibold" style="color: var(--destructive);">
                                                                S/ @detalle.Monto.ToString("N2")
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm" style="color: var(--foreground);">
                                            @egreso.NombreUsuario
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right">
                                        <div class="text-base font-bold" style="color: var(--destructive);">
                                            S/ @egreso.MontoTotal.ToString("N2")
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center justify-center gap-1">
                                            <button onclick="event.stopPropagation(); loadDetailsEgreso('@egreso.IdCabEgreso')"
                                                    class="p-2 rounded-md transition-all hover:shadow-sm"
                                                    style="background-color: oklch(from var(--primary) l c h / 0.1); color: var(--primary);"
                                                    title="Ver detalles">
                                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                                </svg>
                                            </button>
                                            <button onclick="event.stopPropagation(); loadEditEgreso('@egreso.IdCabEgreso')"
                                                    class="p-2 rounded-md transition-all hover:shadow-sm"
                                                    style="background-color: oklch(from var(--chart-2) l c h / 0.1); color: var(--chart-2);"
                                                    title="Editar">
                                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
        else
        {
            <!-- Empty state -->
            <div class="card">
                <div class="px-6 py-16 text-center">
                    <div class="h-20 w-20 rounded-full mx-auto flex items-center justify-center mb-4" 
                         style="background-color: oklch(from var(--muted) l c h / 0.5);">
                        <svg class="h-10 w-10" style="color: var(--muted-foreground);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold mb-2" style="color: var(--foreground);">No hay egresos registrados</h3>
                    <p class="text-sm mb-6" style="color: var(--muted-foreground);">
                        Comienza registrando los gastos operativos del negocio
                    </p>
                    <button onclick="loadCreateEgresoForm()"
                            class="inline-flex items-center px-6 py-2.5 text-sm font-medium rounded-md transition-all hover:opacity-90 shadow-sm" 
                            style="background-color: var(--primary); color: var(--primary-foreground);">
                        <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Registrar Primer Egreso
                    </button>
                </div>
            </div>
        }
    </div>
</div>



@section Scripts {
    <script>
        // Cargar tipos de egreso globalmente
        window.tiposEgreso = @Html.Raw(Json.Serialize(Model.TiposEgreso.Select(t => new { idTipoEgreso = t.IdTipoEgreso, nombre = t.Nombre })));

        // ========== FUNCIÓN DE NOTIFICACIONES ==========
        function mostrarNotificacion(mensaje, tipo = 'success') {
            const colores = {
                'success': 'var(--chart-2)',
                'error': 'var(--destructive)',
                'warning': '#f59e0b',
                'info': 'var(--primary)'
            };
            
            const iconos = {
                'success': '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>',
                'error': '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>',
                'warning': '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>',
                'info': '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
            };
            
            const notificacion = document.createElement('div');
            notificacion.className = 'fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-3 animate-slideIn';
            notificacion.style.backgroundColor = colores[tipo] || colores['info'];
            notificacion.style.color = 'white';
            notificacion.innerHTML = `
                ${iconos[tipo] || iconos['info']}
                <span>${mensaje}</span>
            `;
            
            document.body.appendChild(notificacion);
            
            setTimeout(() => {
                notificacion.style.opacity = '0';
                notificacion.style.transform = 'translateX(100%)';
                notificacion.style.transition = 'all 0.3s ease-out';
                setTimeout(() => notificacion.remove(), 300);
            }, 3000);
        }

        // ========== MODAL DE CONFIRMACIÓN MODERNO ==========
        function mostrarConfirmacion(titulo, mensaje, textoConfirmar = 'Confirmar', textoCancelar = 'Cancelar') {
            return new Promise((resolve) => {
                const modalId = 'confirmModal_' + Date.now();
                const modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 z-[100] flex items-center justify-center';
                modal.style.cssText = 'background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px);';
                
                modal.innerHTML = `
                    <div class="card max-w-md w-full mx-4 shadow-xl transform transition-all animate-slideIn" 
                         style="background-color: var(--card); border: 1px solid var(--border);">
                        <div class="p-6">
                            <div class="flex items-start gap-4">
                                <div class="flex-shrink-0 h-10 w-10 rounded-full flex items-center justify-center" 
                                     style="background-color: var(--destructive); opacity: 0.1;">
                                    <svg class="h-6 w-6" style="color: var(--destructive); opacity: 1;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-lg font-semibold mb-2" style="color: var(--foreground);">${titulo}</h3>
                                    <p class="text-sm" style="color: var(--muted-foreground);">${mensaje}</p>
                                </div>
                            </div>
                            <div class="flex gap-3 mt-6 justify-end">
                                <button type="button" onclick="cerrarConfirmacion('${modalId}', false)" 
                                        class="px-4 py-2 text-sm font-medium rounded-md border transition-all hover:bg-muted/50" 
                                        style="border-color: var(--border); color: var(--foreground);">
                                    ${textoCancelar}
                                </button>
                                <button type="button" onclick="cerrarConfirmacion('${modalId}', true)" 
                                        class="px-4 py-2 text-sm font-medium rounded-md transition-all hover:opacity-90" 
                                        style="background-color: var(--destructive); color: white;">
                                    ${textoConfirmar}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                window.cerrarConfirmacion = (id, resultado) => {
                    const modal = document.getElementById(id);
                    if (modal) {
                        modal.remove();
                    }
                    resolve(resultado);
                };
            });
        }

        // ========== FILTRADO DINÁMICO EN TIEMPO REAL ==========
        const filtroFechaInicio = document.getElementById('filtroFechaInicio');
        const filtroFechaFin = document.getElementById('filtroFechaFin');
        const filtroTipoEgreso = document.getElementById('filtroTipoEgreso');
        const filtroConcepto = document.getElementById('filtroConcepto');
        
        function aplicarFiltros() {
            const fechaInicio = filtroFechaInicio.value ? new Date(filtroFechaInicio.value) : null;
            const fechaFin = filtroFechaFin.value ? new Date(filtroFechaFin.value) : null;
            const tipoSeleccionado = filtroTipoEgreso.value;
            const conceptoBusqueda = filtroConcepto.value.toLowerCase().trim();
            
            const filas = document.querySelectorAll('tbody tr[data-egreso-id]');
            let visibles = 0;
            
            filas.forEach(fila => {
                const fechaEgreso = new Date(fila.dataset.fecha);
                const tiposEgreso = fila.dataset.tipos.split(',');
                const conceptosTexto = fila.querySelectorAll('.concepto-text');
                let conceptosArray = [];
                conceptosTexto.forEach(el => conceptosArray.push(el.textContent.toLowerCase()));
                
                let mostrar = true;
                
                // Filtro por fecha inicio
                if (fechaInicio && fechaEgreso < fechaInicio) {
                    mostrar = false;
                }
                
                // Filtro por fecha fin
                if (fechaFin && fechaEgreso > fechaFin) {
                    mostrar = false;
                }
                
                // Filtro por tipo de egreso
                if (tipoSeleccionado && !tiposEgreso.includes(tipoSeleccionado)) {
                    mostrar = false;
                }
                
                // Filtro por concepto
                if (conceptoBusqueda && !conceptosArray.some(c => c.includes(conceptoBusqueda))) {
                    mostrar = false;
                }
                
                fila.style.display = mostrar ? '' : 'none';
                if (mostrar) visibles++;
            });
            
            // Mostrar mensaje si no hay resultados
            actualizarMensajeVacio(visibles);
            actualizarContadorTotal(visibles);
        }
        
        function actualizarMensajeVacio(visibles) {
            let mensajeVacio = document.getElementById('mensajeVacio');
            const tbody = document.querySelector('tbody');
            
            if (visibles === 0 && !mensajeVacio) {
                mensajeVacio = document.createElement('tr');
                mensajeVacio.id = 'mensajeVacio';
                mensajeVacio.innerHTML = `
                    <td colspan="5" class="px-6 py-16 text-center">
                        <div class="h-16 w-16 rounded-full mx-auto flex items-center justify-center mb-4" 
                             style="background-color: oklch(from var(--muted) l c h / 0.5);">
                            <svg class="h-8 w-8" style="color: var(--muted-foreground);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold mb-2" style="color: var(--foreground);">No se encontraron resultados</h3>
                        <p class="text-sm" style="color: var(--muted-foreground);">
                            Intenta ajustar los filtros de búsqueda
                        </p>
                    </td>
                `;
                tbody.appendChild(mensajeVacio);
            } else if (visibles > 0 && mensajeVacio) {
                mensajeVacio.remove();
            }
        }
        
        function actualizarContadorTotal(visibles) {
            const totalRegistrosCard = document.querySelector('[data-contador-total]');
            if (totalRegistrosCard) {
                totalRegistrosCard.textContent = visibles;
            }
        }
        
        // Event listeners para filtros automáticos
        filtroFechaInicio.addEventListener('change', aplicarFiltros);
        filtroFechaFin.addEventListener('change', aplicarFiltros);
        filtroTipoEgreso.addEventListener('change', aplicarFiltros);
        filtroConcepto.addEventListener('input', aplicarFiltros);
        
        // ========== FUNCIONES GLOBALES PARA MANEJO DE DETALLES ==========
        window.agregarDetalle = function() {
            const container = document.getElementById('detallesContainer');
            const index = container.children.length;
            
            // Detectar si es modal de edición (tiene botón verde) o creación (botón violeta)
            const esEdicion = document.getElementById('btnActualizarEgreso') !== null;
            const colorBoton = esEdicion ? 'var(--chart-2)' : 'var(--primary)';
            
            let optionsTipo = '<option value="">Seleccionar tipo...</option>';
            if (window.tiposEgreso && window.tiposEgreso.length > 0) {
                window.tiposEgreso.forEach(t => {
                    optionsTipo += `<option value="${t.idTipoEgreso}">${t.nombre}</option>`;
                });
            }
            
            const html = `
                <div class="detalle-item p-4 border rounded-lg relative transition-all hover:shadow-sm" 
                     style="background-color: var(--background); border-color: var(--border);" data-index="${index}">
                    <button type="button" onclick="eliminarDetalle(this)" 
                            class="absolute top-3 right-3 p-1.5 rounded-md transition-all"
                            style="background-color: oklch(from var(--destructive) l c h / 0.1); color: var(--destructive);">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pr-10">
                        <div class="md:col-span-2">
                            <label class="block text-xs font-medium mb-1.5" style="color: var(--foreground);">Concepto *</label>
                            <input type="text" class="concepto w-full px-3 py-2 text-sm border rounded-md focus:outline-none focus:ring-2 transition-all" 
                                   style="border-color: var(--border); background-color: var(--background); color: var(--foreground); --tw-ring-color: ${colorBoton};"
                                   placeholder="Ej: Pago de servicios básicos" 
                                   minlength="3" maxlength="200" 
                                   pattern="[a-zA-ZáéíóúÁÉÍÓÚñÑ0-9\s\.,\-\(\)]+" 
                                   title="Mínimo 3 caracteres. Solo letras, números, espacios y puntuación básica" 
                                   required />
                        </div>
                        <div>
                            <label class="block text-xs font-medium mb-1.5" style="color: var(--foreground);">Tipo de Egreso *</label>
                            <select class="tipoEgreso w-full px-3 py-2 text-sm border rounded-md focus:outline-none focus:ring-2 transition-all" 
                                    style="border-color: var(--border); background-color: var(--background); color: var(--foreground); --tw-ring-color: ${colorBoton};"
                                    required>
                                ${optionsTipo}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium mb-1.5" style="color: var(--foreground);">Monto (S/) *</label>
                            <input type="number" class="monto w-full px-3 py-2 text-sm border rounded-md focus:outline-none focus:ring-2 transition-all" 
                                   style="border-color: var(--border); background-color: var(--background); color: var(--foreground); --tw-ring-color: ${colorBoton};"
                                   min="0.01" max="999999.99" step="0.01" placeholder="0.00" 
                                   title="Ingrese un monto entre S/ 0.01 y S/ 999,999.99" 
                                   onchange="calcularTotal()" required />
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-medium mb-1.5" style="color: var(--foreground);">Comprobante / Referencia</label>
                            <div class="flex gap-2">
                                <input type="text" class="comprobante w-full px-3 py-2 text-sm border rounded-md focus:outline-none focus:ring-2 transition-all" 
                                    style="border-color: var(--border); background-color: var(--background); color: var(--foreground); --tw-ring-color: ${colorBoton};"
                                    maxlength="255" placeholder="Ej: Factura #001-0012345 o suba un archivo" 
                                    pattern="[a-zA-Z0-9\\s\\-_\\.\\/#]+" 
                                    title="Solo letras, números, espacios, guiones, puntos, barras y #" />
                                <input type="file" class="archivoComprobante hidden" accept=".pdf,.jpg,.jpeg,.png" />
                                <button type="button" onclick="seleccionarArchivo(this)" 
                                        class="px-3 py-2 text-xs font-medium rounded-md border transition-all hover:bg-muted/50 whitespace-nowrap"
                                        style="border-color: var(--border); color: var(--foreground);"
                                        title="Subir archivo PDF o imagen">
                                    <svg class="h-4 w-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                    Archivo
                                </button>
                            </div>
                            <p class="text-xs mt-1" style="color: var(--muted-foreground);">Ingrese texto o suba un archivo (PDF, JPG, PNG, máx 5MB)</p>
                        </div>
                        <div class="md:col-span-2 flex items-center space-x-2">
                            <input type="checkbox" class="recurrente h-4 w-4 rounded border transition-all" 
                                   style="border-color: var(--input); color: ${colorBoton};" />
                            <label class="text-xs" style="color: var(--foreground);">
                                Es un gasto recurrente (se repite periódicamente)
                            </label>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', html);
        };

        window.eliminarDetalle = function(button) {
            const item = button.closest('.detalle-item');
            if (item) {
                item.remove();
                calcularTotal();
                
                // Si no quedan detalles, resetear total
                const container = document.getElementById('detallesContainer');
                if (container.children.length === 0) {
                    const totalDisplay = document.getElementById('totalDisplay');
                    if (totalDisplay) {
                        totalDisplay.textContent = 'S/ 0.00';
                    }
                }
            }
        };

        window.seleccionarArchivo = function(btn) {
            const detalleItem = btn.closest('.detalle-item');
            const fileInput = detalleItem.querySelector('.archivoComprobante');
            const textInput = detalleItem.querySelector('.comprobante');
            
            fileInput.click();
            
            fileInput.onchange = function() {
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    
                    // Validar tamaño (5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        mostrarNotificacion('El archivo no debe superar 5MB', 'error');
                        fileInput.value = '';
                        return;
                    }
                    
                    // Validar extensión
                    const ext = file.name.split('.').pop().toLowerCase();
                    if (!['pdf', 'jpg', 'jpeg', 'png'].includes(ext)) {
                        mostrarNotificacion('Solo se permiten archivos PDF, JPG o PNG', 'error');
                        fileInput.value = '';
                        return;
                    }
                    
                    textInput.value = file.name;
                    textInput.readOnly = true;
                    textInput.style.backgroundColor = 'oklch(from var(--muted) l c h / 0.5)';
                    btn.innerHTML = `<svg class="h-4 w-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg> ${file.name.length > 12 ? file.name.substring(0, 12) + '...' : file.name}`;
                    btn.style.backgroundColor = 'var(--chart-2)';
                    btn.style.color = 'white';
                }
            };
        };

        window.calcularTotal = function() {
            const montos = document.querySelectorAll('#detallesContainer .monto');
            let total = 0;
            montos.forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            const displayEl = document.getElementById('totalDisplay');
            if (displayEl) {
                displayEl.textContent = 'S/ ' + total.toFixed(2);
            }
        };

        window.guardarEgreso = async function() {
            const detalles = [];
            const items = document.querySelectorAll('#detallesContainer .detalle-item');
            
            if (items.length === 0) {
                mostrarNotificacion('Debe agregar al menos un concepto de egreso', 'warning');
                return;
            }
            
            let valido = true;
            let primerCampoInvalido = null;
            
            items.forEach((item, index) => {
                const concepto = item.querySelector('.concepto').value.trim();
                const tipo = parseInt(item.querySelector('.tipoEgreso').value);
                const monto = parseFloat(item.querySelector('.monto').value);
                const recurrente = item.querySelector('.recurrente').checked;
                const comprobante = item.querySelector('.comprobante').value.trim() || null;
                
                // Referencias a inputs para resaltar
                const inputConcepto = item.querySelector('.concepto');
                const selectTipo = item.querySelector('.tipoEgreso');
                const inputMonto = item.querySelector('.monto');
                const inputComprobante = item.querySelector('.comprobante');
                
                // Limpiar estilos previos
                [inputConcepto, selectTipo, inputMonto, inputComprobante].forEach(el => {
                    if (el) {
                        el.style.borderColor = '';
                        el.style.boxShadow = '';
                    }
                });
                
                // Validaciones con resaltado visual
                if (!concepto || concepto.length < 3) {
                    valido = false;
                    inputConcepto.style.borderColor = 'var(--destructive)';
                    inputConcepto.style.boxShadow = '0 0 0 3px oklch(from var(--destructive) l c h / 0.1)';
                    if (!primerCampoInvalido) primerCampoInvalido = inputConcepto;
                    return;
                }
                if (!tipo || tipo <= 0) {
                    valido = false;
                    selectTipo.style.borderColor = 'var(--destructive)';
                    selectTipo.style.boxShadow = '0 0 0 3px oklch(from var(--destructive) l c h / 0.1)';
                    if (!primerCampoInvalido) primerCampoInvalido = selectTipo;
                    return;
                }
                if (!monto || monto < 0.01 || monto > 999999.99) {
                    valido = false;
                    inputMonto.style.borderColor = 'var(--destructive)';
                    inputMonto.style.boxShadow = '0 0 0 3px oklch(from var(--destructive) l c h / 0.1)';
                    if (!primerCampoInvalido) primerCampoInvalido = inputMonto;
                    return;
                }
                if (comprobante && comprobante.length > 255) {
                    valido = false;
                    inputComprobante.style.borderColor = 'var(--destructive)';
                    inputComprobante.style.boxShadow = '0 0 0 3px oklch(from var(--destructive) l c h / 0.1)';
                    if (!primerCampoInvalido) primerCampoInvalido = inputComprobante;
                    return;
                }
                
                detalles.push({
                    concepto: concepto,
                    idTipoEgreso: tipo,
                    monto: monto,
                    recurrente: recurrente,
                    comprobanteRuta: comprobante
                });
            });
            
            if (!valido) {
                if (primerCampoInvalido) {
                    primerCampoInvalido.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    primerCampoInvalido.focus();
                }
                mostrarNotificacion('Complete correctamente todos los campos obligatorios', 'error');
                return;
            }
            
            const fecha = document.getElementById('fechaEgreso').value;
            const btn = document.getElementById('btnGuardarEgreso');
            
            btn.disabled = true;
            btn.textContent = 'Guardando...';
            
            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                
                // Crear FormData en lugar de JSON
                const formData = new FormData();
                formData.append('data', JSON.stringify({
                    fecha: fecha,
                    detalles: detalles.map(d => ({
                        concepto: d.concepto,
                        idTipoEgreso: d.idTipoEgreso,
                        monto: d.monto,
                        recurrente: d.recurrente,
                        comprobanteRuta: d.comprobanteRuta
                    }))
                }));

                // Agregar archivos si existen
                items.forEach((item, index) => {
                    const fileInput = item.querySelector('.archivoComprobante');
                    if (fileInput && fileInput.files.length > 0) {
                        formData.append(`archivo_${index}`, fileInput.files[0]);
                    }
                });

                const response = await fetch('/api/EgresosApi', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData // NO enviar Content-Type, el navegador lo configura automáticamente
                });
                
                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    
                    if (contentType && contentType.includes('application/json')) {
                        const result = await response.json();
                        
                        if (result.success) {
                            Modal.close('crudModal');
                            mostrarNotificacion(result.message || '✅ Egreso registrado exitosamente', 'success');
                            
                            setTimeout(() => {
                                location.reload();
                            }, 1500);
                        } else {
                            mostrarNotificacion(result.message || 'No se pudo guardar el egreso', 'error');
                            btn.disabled = false;
                            btn.textContent = 'Registrar Egreso';
                        }
                    } else {
                        mostrarNotificacion('Respuesta inesperada del servidor', 'error');
                        btn.disabled = false;
                        btn.textContent = 'Registrar Egreso';
                    }
                } else {
                    const text = await response.text();
                    
                    try {
                        const result = JSON.parse(text);
                        mostrarNotificacion(result.message || 'No se pudo guardar el egreso', 'error');
                    } catch (e) {
                        mostrarNotificacion(`Error al guardar. Código: ${response.status}`, 'error');
                    }
                    btn.disabled = false;
                    btn.textContent = 'Registrar Egreso';
                }
            } catch (error) {
                mostrarNotificacion(error.message || 'Error al guardar el egreso', 'error');
                btn.disabled = false;
                btn.textContent = 'Registrar Egreso';
            }
        };

        // Función para cargar formulario de crear egreso
        async function loadCreateEgresoForm() {
            try {
                const response = await fetch('/Egresos/Index?handler=CreateModal', {
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    }
                });
                const html = await response.text();
                document.getElementById('modalContent').innerHTML = html;
                Modal.open('crudModal');
                
                // Agregar primer detalle después de abrir el modal
                setTimeout(() => {
                    agregarDetalle();
                }, 100);
            } catch (error) {
                mostrarNotificacion('Error al cargar el formulario', 'error');
            }
        }

        // Función para ver detalles del egreso
        async function loadDetailsEgreso(id) {
            try {
                const response = await fetch(`/Egresos/Index?handler=DetailsModal&id=${id}`);
                const html = await response.text();
                document.getElementById('modalContent').innerHTML = html;
                Modal.open('crudModal');
            } catch (error) {
                mostrarNotificacion('Error al cargar los detalles', 'error');
            }
        }

        // Función para editar egreso
        async function loadEditEgreso(id) {
            try {
                const response = await fetch(`/Egresos/Index?handler=EditModal&id=${id}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        mostrarNotificacion('El egreso no existe o fue eliminado', 'error');
                    } else {
                        mostrarNotificacion(`Error del servidor: ${response.status}`, 'error');
                    }
                    return;
                }
                
                const html = await response.text();
                document.getElementById('modalContent').innerHTML = html;
                Modal.open('crudModal');
                
                // Recalcular total después de cargar
                setTimeout(() => calcularTotal(), 100);
            } catch (error) {
                mostrarNotificacion('Error al cargar el formulario de edición', 'error');
            }
        }

        // Función para cargar confirmación de eliminación
        async function loadDeleteEgresoConfirm(id) {
            try {
                const response = await fetch(`/Egresos/Index?handler=DeleteModal&id=${id}`);
                const html = await response.text();
                document.getElementById('modalContent').innerHTML = html;
                Modal.open('crudModal');
            } catch (error) {
                mostrarNotificacion('Error al cargar el formulario de eliminación', 'error');
            }
        }

        // Manejar submit de formularios en modales
        document.addEventListener('submit', async function(e) {
            if (e.target.closest('.modal-content')) {
                e.preventDefault();
                
                const form = e.target;
                const formData = new FormData(form);
                
                try {
                    const response = await fetch(form.action, {
                        method: form.method,
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });

                    if (response.ok) {
                        const contentType = response.headers.get('content-type');
                        
                        // Si es JSON (éxito)
                        if (contentType && contentType.includes('application/json')) {
                            const result = await response.json();
                            if (result.success) {
                                Modal.close('crudModal');
                                mostrarNotificacion(result.message || '✅ Operación exitosa', 'success');
                                
                                setTimeout(() => {
                                    location.reload();
                                }, 1500);
                            }
                        } else {
                            // Si es HTML parcial (hay errores de validación)
                            const html = await response.text();
                            document.getElementById('modalContent').innerHTML = html;
                        }
                    } else {
                        const html = await response.text();
                        document.getElementById('modalContent').innerHTML = html;
                    }
                } catch (error) {
                    mostrarNotificacion('Error al guardar los cambios', 'error');
                }
            }
        });

        // ========== FUNCIÓN PARA ACTUALIZAR EGRESO ==========
        window.actualizarEgreso = async function() {
            const id = document.getElementById('idCabEgresoEdit').value;
            const detalles = [];
            const items = document.querySelectorAll('#detallesContainer .detalle-item');
            
            if (items.length === 0) {
                mostrarNotificacion('Debe agregar al menos un concepto de egreso', 'warning');
                return;
            }
            
            let valido = true;
            let primerCampoInvalido = null;
            
            items.forEach((item, index) => {
                const concepto = item.querySelector('.concepto').value.trim();
                const tipo = parseInt(item.querySelector('.tipoEgreso').value);
                const monto = parseFloat(item.querySelector('.monto').value);
                const recurrente = item.querySelector('.recurrente').checked;
                const comprobante = item.querySelector('.comprobante').value.trim() || null;
                
                // Referencias a inputs para resaltar
                const inputConcepto = item.querySelector('.concepto');
                const selectTipo = item.querySelector('.tipoEgreso');
                const inputMonto = item.querySelector('.monto');
                const inputComprobante = item.querySelector('.comprobante');
                
                // Limpiar estilos previos
                [inputConcepto, selectTipo, inputMonto, inputComprobante].forEach(el => {
                    if (el) {
                        el.style.borderColor = '';
                        el.style.boxShadow = '';
                    }
                });
                
                // Validaciones con resaltado visual
                if (!concepto || concepto.length < 3) {
                    valido = false;
                    inputConcepto.style.borderColor = 'var(--destructive)';
                    inputConcepto.style.boxShadow = '0 0 0 3px oklch(from var(--destructive) l c h / 0.1)';
                    if (!primerCampoInvalido) primerCampoInvalido = inputConcepto;
                    return;
                }
                if (!tipo || tipo <= 0) {
                    valido = false;
                    selectTipo.style.borderColor = 'var(--destructive)';
                    selectTipo.style.boxShadow = '0 0 0 3px oklch(from var(--destructive) l c h / 0.1)';
                    if (!primerCampoInvalido) primerCampoInvalido = selectTipo;
                    return;
                }
                if (!monto || monto < 0.01 || monto > 999999.99) {
                    valido = false;
                    inputMonto.style.borderColor = 'var(--destructive)';
                    inputMonto.style.boxShadow = '0 0 0 3px oklch(from var(--destructive) l c h / 0.1)';
                    if (!primerCampoInvalido) primerCampoInvalido = inputMonto;
                    return;
                }
                if (comprobante && comprobante.length > 255) {
                    valido = false;
                    inputComprobante.style.borderColor = 'var(--destructive)';
                    inputComprobante.style.boxShadow = '0 0 0 3px oklch(from var(--destructive) l c h / 0.1)';
                    if (!primerCampoInvalido) primerCampoInvalido = inputComprobante;
                    return;
                }
                
                detalles.push({
                    concepto: concepto,
                    idTipoEgreso: tipo,
                    monto: monto,
                    recurrente: recurrente,
                    comprobanteRuta: comprobante
                });
            });
            
            if (!valido) {
                if (primerCampoInvalido) {
                    primerCampoInvalido.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    primerCampoInvalido.focus();
                }
                mostrarNotificacion('Complete correctamente todos los campos obligatorios', 'error');
                return;
            }
            
            const fecha = document.getElementById('fechaEgresoEdit').value;
            const btn = document.getElementById('btnActualizarEgreso');
            
            btn.disabled = true;
            btn.textContent = 'Guardando...';
            
            try {
                const formData = new FormData();
                formData.append('data', JSON.stringify({
                    fecha: fecha,
                    detalles: detalles.map(d => ({
                        concepto: d.concepto,
                        idTipoEgreso: d.idTipoEgreso,
                        monto: d.monto,
                        recurrente: d.recurrente,
                        comprobanteRuta: d.comprobanteRuta
                    }))
                }));

                // Agregar archivos
                items.forEach((item, index) => {
                    const fileInput = item.querySelector('.archivoComprobante');
                    if (fileInput && fileInput.files.length > 0) {
                        formData.append(`archivo_${index}`, fileInput.files[0]);
                    }
                });

                const response = await fetch(`/api/EgresosApi/${id}`, {
                    method: 'PUT',
                    credentials: 'include',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.success) {
                        Modal.close('crudModal');
                        mostrarNotificacion(result.message || '✅ Egreso actualizado exitosamente', 'success');
                        
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        mostrarNotificacion(result.message || 'No se pudo guardar el egreso', 'error');
                        btn.disabled = false;
                        btn.innerHTML = '<svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Guardar Cambios';
                    }
                } else {
                    const text = await response.text();
                    
                    try {
                        const result = JSON.parse(text);
                        mostrarNotificacion(result.message || 'No se pudo actualizar el egreso', 'error');
                    } catch (e) {
                        mostrarNotificacion(`Error al actualizar. Código: ${response.status}`, 'error');
                    }
                    btn.disabled = false;
                    btn.innerHTML = '<svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Guardar Cambios';
                }
            } catch (error) {
                mostrarNotificacion(error.message || 'Error al actualizar el egreso', 'error');
                btn.disabled = false;
                btn.innerHTML = '<svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Guardar Cambios';
            }
        };

        // ========== GESTIÓN DE TIPOS DE EGRESO ==========
        
        async function abrirModalTipos() {
            try {
                const response = await fetch('/Egresos/Index?handler=TiposModal');
                const html = await response.text();
                document.getElementById('modalContent').innerHTML = html;
                Modal.open('crudModal');
            } catch (error) {
                mostrarNotificacion('Error al abrir gestión de tipos', 'error');
                console.error(error);
            }
        }

        async function crearTipoEgreso() {
            const input = document.getElementById('nuevoTipoNombre');
            const nombre = input.value.trim();
            
            if (!nombre) {
                mostrarNotificacion('Ingrese un nombre para el tipo', 'warning');
                input.focus();
                return;
            }

            if (nombre.length > 50) {
                mostrarNotificacion('El nombre no debe exceder 50 caracteres', 'warning');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('nombre', nombre);
                formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);
                
                const response = await fetch('/Egresos/Index?handler=CrearTipo', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    mostrarNotificacion('Tipo creado exitosamente', 'success');
                    input.value = '';
                    await recargarModalTipos();
                    await recargarTiposGlobales();
                } else {
                    mostrarNotificacion(result.message || 'Error al crear tipo', 'error');
                }
            } catch (error) {
                mostrarNotificacion('Error al crear el tipo', 'error');
                console.error(error);
            }
        }

        function editarTipoEgreso(id) {
            const fila = document.querySelector(`tr[data-tipo-id="${id}"]`);
            if (!fila) return;

            const nombreSpan = fila.querySelector('.tipo-nombre');
            const nombreInput = fila.querySelector('.tipo-nombre-input');
            const btnEditar = fila.querySelector('.btn-editar');
            const btnGuardar = fila.querySelector('.btn-guardar');
            const btnCancelar = fila.querySelector('.btn-cancelar');
            const btnEliminar = fila.querySelector('.btn-eliminar');

            // Guardar valor original
            nombreInput.dataset.valorOriginal = nombreInput.value;

            // Mostrar input, ocultar span
            nombreSpan.classList.add('hidden');
            nombreInput.classList.remove('hidden');
            nombreInput.focus();
            nombreInput.select();

            // Cambiar botones
            btnEditar.classList.add('hidden');
            btnEliminar.classList.add('hidden');
            btnGuardar.classList.remove('hidden');
            btnCancelar.classList.remove('hidden');
        }

        async function guardarEdicionTipo(id) {
            const fila = document.querySelector(`tr[data-tipo-id="${id}"]`);
            if (!fila) return;

            const nombreInput = fila.querySelector('.tipo-nombre-input');
            const nombre = nombreInput.value.trim();

            if (!nombre) {
                mostrarNotificacion('El nombre no puede estar vacío', 'warning');
                nombreInput.focus();
                return;
            }

            if (nombre.length > 50) {
                mostrarNotificacion('El nombre no debe exceder 50 caracteres', 'warning');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('nombre', nombre);
                formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);
                
                const response = await fetch(`/Egresos/Index?handler=ActualizarTipo&id=${id}`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    mostrarNotificacion('Tipo actualizado exitosamente', 'success');
                    await recargarModalTipos();
                    await recargarTiposGlobales();
                } else {
                    mostrarNotificacion(result.message || 'Error al actualizar tipo', 'error');
                }
            } catch (error) {
                mostrarNotificacion('Error al actualizar el tipo', 'error');
                console.error(error);
            }
        }

        function cancelarEdicionTipo(id) {
            const fila = document.querySelector(`tr[data-tipo-id="${id}"]`);
            if (!fila) return;

            const nombreSpan = fila.querySelector('.tipo-nombre');
            const nombreInput = fila.querySelector('.tipo-nombre-input');
            const btnEditar = fila.querySelector('.btn-editar');
            const btnGuardar = fila.querySelector('.btn-guardar');
            const btnCancelar = fila.querySelector('.btn-cancelar');
            const btnEliminar = fila.querySelector('.btn-eliminar');

            // Restaurar valor original
            nombreInput.value = nombreInput.dataset.valorOriginal || nombreInput.value;

            // Ocultar input, mostrar span
            nombreInput.classList.add('hidden');
            nombreSpan.classList.remove('hidden');

            // Cambiar botones
            btnGuardar.classList.add('hidden');
            btnCancelar.classList.add('hidden');
            btnEditar.classList.remove('hidden');
            btnEliminar.classList.remove('hidden');
        }

        async function eliminarTipoEgreso(id, nombre) {
            // Mostrar modal de confirmación moderno
            const confirmar = await mostrarConfirmacion(
                '¿Eliminar tipo de egreso?',
                `¿Está seguro de eliminar el tipo "${nombre}"? Esta acción no se puede deshacer.`,
                'Eliminar',
                'Cancelar'
            );
            
            if (!confirmar) return;

            try {
                const formData = new FormData();
                formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);
                
                const response = await fetch(`/Egresos/Index?handler=EliminarTipo&id=${id}`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    mostrarNotificacion('Tipo eliminado exitosamente', 'success');
                    await recargarModalTipos();
                    await recargarTiposGlobales();
                } else {
                    mostrarNotificacion(result.message || 'No se pudo eliminar el tipo', 'error');
                }
            } catch (error) {
                mostrarNotificacion('Error al eliminar el tipo', 'error');
                console.error(error);
            }
        }

        async function recargarModalTipos() {
            try {
                const response = await fetch('/Egresos/Index?handler=TiposModal');
                const html = await response.text();
                document.getElementById('modalContent').innerHTML = html;
            } catch (error) {
                console.error('Error al recargar modal de tipos:', error);
            }
        }

        async function recargarTiposGlobales() {
            try {
                const response = await fetch('/Egresos/Index?handler=ListarTipos');
                const result = await response.json();
                if (result.success && result.data) {
                    window.tiposEgreso = result.data.map(t => ({
                        idTipoEgreso: t.idTipoEgreso,
                        nombre: t.nombre
                    }));
                    
                    // Actualizar el select de filtro de tipos en la grilla principal
                    actualizarSelectTiposFiltro();
                }
            } catch (error) {
                console.error('Error al recargar tipos globales:', error);
            }
        }

        // ========== ACTUALIZAR SELECT DE TIPOS EN FILTRO ==========
        function actualizarSelectTiposFiltro() {
            const selectTipos = document.getElementById('filtroTipoEgreso');
            if (!selectTipos) return;

            const valorActual = selectTipos.value;
            
            // Limpiar opciones excepto "Todos"
            selectTipos.innerHTML = '<option value="">Todos los tipos</option>';
            
            // Agregar tipos dinámicamente
            if (window.tiposEgreso && Array.isArray(window.tiposEgreso)) {
                window.tiposEgreso.forEach(tipo => {
                    const option = document.createElement('option');
                    option.value = tipo.idTipoEgreso;
                    option.textContent = tipo.nombre;
                    if (tipo.idTipoEgreso == valorActual) {
                        option.selected = true;
                    }
                    selectTipos.appendChild(option);
                });
            }
        }

        // ========== FILTRADO DE TIPOS EN MODAL ==========
        function filtrarTipos() {
            const busqueda = document.getElementById('buscarTipo')?.value.toLowerCase().trim() || '';
            const filas = document.querySelectorAll('#tiposTableBody tr');
            
            let visibles = 0;
            filas.forEach(fila => {
                const nombre = fila.querySelector('.tipo-nombre')?.textContent.toLowerCase() || '';
                const coincide = nombre.includes(busqueda);
                fila.style.display = coincide ? '' : 'none';
                if (coincide) visibles++;
            });

            // Mostrar mensaje si no hay resultados
            const tbody = document.getElementById('tiposTableBody');
            let mensajeNoResultados = tbody.querySelector('.no-resultados-tipos');
            
            if (visibles === 0 && !mensajeNoResultados) {
                mensajeNoResultados = document.createElement('tr');
                mensajeNoResultados.className = 'no-resultados-tipos';
                mensajeNoResultados.innerHTML = `
                    <td colspan="3" class="px-4 py-8 text-center">
                        <p class="text-sm" style="color: var(--muted-foreground);">No se encontraron tipos con "${busqueda}"</p>
                    </td>
                `;
                tbody.appendChild(mensajeNoResultados);
            } else if (visibles > 0 && mensajeNoResultados) {
                mensajeNoResultados.remove();
            }
        }
    </script>
}
